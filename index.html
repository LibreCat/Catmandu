<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Catmandu</title>
  <style type="text/css">code{white-space: pre;}</style>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

  <style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; }
code > span.dt { color: #902000; }
code > span.dv { color: #40a070; }
code > span.bn { color: #40a070; }
code > span.fl { color: #40a070; }
code > span.ch { color: #4070a0; }
code > span.st { color: #4070a0; }
code > span.co { color: #60a0b0; font-style: italic; }
code > span.ot { color: #007020; }
code > span.al { color: #ff0000; font-weight: bold; }
code > span.fu { color: #06287e; }
code > span.er { color: #ff0000; font-weight: bold; }
  </style>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
  <link rel="stylesheet" href="layout.css">
</head>
<body>

<!-- Fixed navbar -->
    <div class="navbar navbar-inverse navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <!--div class="navbar-header">
          <a class="navbar-brand" href="#">Project name</a>
        </div-->
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li>
              <a href="/index.html">Home</a>
            </li>
            <li class="active">
              <a href="/Catmandu">Documentation</a>
            </li>
            <li class="">
              <a href="/distributions.html">Distributions</a>
            </li>
            <li class="">
              <a href="/Catmandu#fixes-cheat-sheet">Cheat Sheet</a>
            </li>
            <li class="">
              <a href="/events.html">Events &mdash; Workshops</a>
            </li>
            <li>
              <a href="https://librecatproject.wordpress.com/">Blog</a>
            </li>
            <li>
              <a href="http://demo.librecat.org/">Demo</a>
            </li>
            <li>
              <a href="/about.html">About</a>
            </li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>

<div class="container">

<div class="jumbotron">
<h1 class="title">Catmandu</h1>
<h2 class="subtitle">a data toolkit</h2>
</div>

<p>
  This handbook is contains the aggregated content of
  <a href="https://github.com/LibreCat/Catmandu/wiki">Catmandu documentation wiki</a>. 
  Feel free to improve the documentation there!
</p>

<nav id="TOC">
<h1>Table of Contents</h1>
<ul>
<li><a href="#introduction"><span class="toc-section-number">1</span> Introduction <a href="https://github.com/LibreCat/Catmandu/wiki/Introduction">✎</a></a></li>
<li><a href="#installation"><span class="toc-section-number">2</span> Installation <a href="https://github.com/LibreCat/Catmandu/wiki/Installation">✎</a></a><ul>
<li><a href="#debian"><span class="toc-section-number">2.0.1</span> Debian</a></li>
<li><a href="#ubuntu-server-12.04.4-lts"><span class="toc-section-number">2.0.2</span> Ubuntu Server 12.04.4 LTS</a></li>
<li><a href="#centos-6.4"><span class="toc-section-number">2.0.3</span> CentOS 6.4</a></li>
<li><a href="#centos-7"><span class="toc-section-number">2.0.4</span> CentOS 7</a></li>
<li><a href="#opensuse"><span class="toc-section-number">2.0.5</span> openSUSE</a></li>
<li><a href="#openbsd-53"><span class="toc-section-number">2.0.6</span> OpenBSD 53</a></li>
<li><a href="#osx"><span class="toc-section-number">2.0.7</span> OSX</a></li>
<li><a href="#windows-mac-osx-linux"><span class="toc-section-number">2.0.8</span> Windows, Mac OSX, Linux</a></li>
<li><a href="#raspbian-gnulinux-7-on-the-raspberry-pi-armhf"><span class="toc-section-number">2.0.9</span> Raspbian GNU/Linux 7 on the Raspberry Pi (armhf)</a></li>
</ul></li>
<li><a href="#command-line-client"><span class="toc-section-number">3</span> Command line client <a href="https://github.com/LibreCat/Catmandu/wiki/Command%20line%20client">✎</a></a></li>
<li><a href="#concepts"><span class="toc-section-number">4</span> Concepts <a href="https://github.com/LibreCat/Catmandu/wiki/Concepts">✎</a></a><ul>
<li><a href="#items"><span class="toc-section-number">4.1</span> Items <a href="https://github.com/LibreCat/Catmandu/wiki/Items">✎</a></a></li>
<li><a href="#importers"><span class="toc-section-number">4.2</span> Importers <a href="https://github.com/LibreCat/Catmandu/wiki/Importers">✎</a></a></li>
<li><a href="#exporters"><span class="toc-section-number">4.3</span> Exporters <a href="https://github.com/LibreCat/Catmandu/wiki/Exporters">✎</a></a></li>
<li><a href="#stores"><span class="toc-section-number">4.4</span> Stores <a href="https://github.com/LibreCat/Catmandu/wiki/Stores">✎</a></a></li>
<li><a href="#filestore"><span class="toc-section-number">4.5</span> FileStore <a href="https://github.com/LibreCat/Catmandu/wiki/FileStore">✎</a></a><ul>
<li><a href="#bag"><span class="toc-section-number">4.5.1</span> Bag</a></li>
<li><a href="#index"><span class="toc-section-number">4.5.2</span> Index</a></li>
<li><a href="#technical-metadata"><span class="toc-section-number">4.5.3</span> Technical Metadata</a></li>
<li><a href="#configuration-1"><span class="toc-section-number">4.5.4</span> Configuration</a></li>
</ul></li>
<li><a href="#fixes"><span class="toc-section-number">4.6</span> Fixes <a href="https://github.com/LibreCat/Catmandu/wiki/Fixes">✎</a></a></li>
</ul></li>
<li><a href="#fix-language"><span class="toc-section-number">5</span> Fix language <a href="https://github.com/LibreCat/Catmandu/wiki/Fix%20language">✎</a></a><ul>
<li><a href="#paths"><span class="toc-section-number">5.1</span> Paths <a href="https://github.com/LibreCat/Catmandu/wiki/Paths">✎</a></a><ul>
<li><a href="#wildcards"><span class="toc-section-number">5.1.1</span> Wildcards</a></li>
<li><a href="#marc-mab-pica-paths"><span class="toc-section-number">5.1.2</span> MARC, MAB, PICA paths</a></li>
</ul></li>
<li><a href="#functions"><span class="toc-section-number">5.2</span> Functions <a href="https://github.com/LibreCat/Catmandu/wiki/Functions">✎</a></a></li>
<li><a href="#selectors"><span class="toc-section-number">5.3</span> Selectors <a href="https://github.com/LibreCat/Catmandu/wiki/Selectors">✎</a></a></li>
<li><a href="#conditionals"><span class="toc-section-number">5.4</span> Conditionals <a href="https://github.com/LibreCat/Catmandu/wiki/Conditionals">✎</a></a></li>
<li><a href="#binds"><span class="toc-section-number">5.5</span> Binds <a href="https://github.com/LibreCat/Catmandu/wiki/Binds">✎</a></a></li>
<li><a href="#comments"><span class="toc-section-number">5.6</span> Comments <a href="https://github.com/LibreCat/Catmandu/wiki/Comments">✎</a></a></li>
</ul></li>
<li><a href="#cheat-sheets"><span class="toc-section-number">6</span> Cheat sheets <a href="https://github.com/LibreCat/Catmandu/wiki/Cheat%20sheets">✎</a></a><ul>
<li><a href="#command-line-client-cheat-sheet"><span class="toc-section-number">6.1</span> Command line client Cheat Sheet <a href="https://github.com/LibreCat/Catmandu/wiki/Command%20line%20client%20Cheat%20Sheet">✎</a></a><ul>
<li><a href="#convert-1"><span class="toc-section-number">6.1.1</span> Convert</a></li>
<li><a href="#importexport"><span class="toc-section-number">6.1.2</span> Import/Export</a></li>
<li><a href="#copy"><span class="toc-section-number">6.1.3</span> Copy</a></li>
<li><a href="#count"><span class="toc-section-number">6.1.4</span> Count</a></li>
<li><a href="#delete"><span class="toc-section-number">6.1.5</span> Delete</a></li>
<li><a href="#configuration-2"><span class="toc-section-number">6.1.6</span> Configuration</a></li>
<li><a href="#stream"><span class="toc-section-number">6.1.7</span> Stream</a></li>
</ul></li>
<li><a href="#fixes-cheat-sheet"><span class="toc-section-number">6.2</span> Fixes Cheat Sheet <a href="https://github.com/LibreCat/Catmandu/wiki/Fixes%20Cheat%20Sheet">✎</a></a></li>
<li><a href="#example-fix-script"><span class="toc-section-number">6.3</span> Example Fix Script <a href="https://github.com/LibreCat/Catmandu/wiki/Example%20Fix%20Script">✎</a></a></li>
<li><a href="#cookbook"><span class="toc-section-number">6.4</span> Cookbook <a href="https://github.com/LibreCat/Catmandu/wiki/Cookbook">✎</a></a></li>
</ul></li>
<li><a href="#api"><span class="toc-section-number">7</span> API <a href="https://github.com/LibreCat/Catmandu/wiki/API">✎</a></a><ul>
<li><a href="#fix-packages"><span class="toc-section-number">7.1</span> Fix packages <a href="https://github.com/LibreCat/Catmandu/wiki/Fix%20packages">✎</a></a></li>
</ul></li>
<li><a href="#contribution"><span class="toc-section-number">8</span> Contribution <a href="https://github.com/LibreCat/Catmandu/wiki/Contribution">✎</a></a><ul>
<li><a href="#ways-to-contribute"><span class="toc-section-number">8.1</span> Ways to contribute</a><ul>
<li><a href="#publicity"><span class="toc-section-number">8.1.1</span> Publicity</a></li>
<li><a href="#mailing-list"><span class="toc-section-number">8.1.2</span> Mailing list</a></li>
<li><a href="#documentation"><span class="toc-section-number">8.1.3</span> Documentation</a></li>
<li><a href="#code"><span class="toc-section-number">8.1.4</span> Code</a></li>
</ul></li>
<li><a href="#quality-supervision-and-reporting-bugs"><span class="toc-section-number">8.2</span> Quality Supervision and Reporting Bugs</a></li>
<li><a href="#resources-for-developers"><span class="toc-section-number">8.3</span> RESOURCES FOR DEVELOPERS</a><ul>
<li><a href="#website"><span class="toc-section-number">8.3.1</span> Website</a></li>
<li><a href="#mailing-lists"><span class="toc-section-number">8.3.2</span> Mailing Lists</a></li>
<li><a href="#repositories"><span class="toc-section-number">8.3.3</span> Repositories</a></li>
<li><a href="#core-maintainers"><span class="toc-section-number">8.3.4</span> Core Maintainers</a></li>
</ul></li>
<li><a href="#acknowledgement"><span class="toc-section-number">8.4</span> Acknowledgement</a></li>
<li><a href="#development-setup"><span class="toc-section-number">8.5</span> Development Setup <a href="https://github.com/LibreCat/Catmandu/wiki/Development%20Setup">✎</a></a><ul>
<li><a href="#set-up-a-development-environment"><span class="toc-section-number">8.5.1</span> Set up a development environment</a></li>
<li><a href="#install-dependencies-required"><span class="toc-section-number">8.5.2</span> Install dependencies (required)</a></li>
<li><a href="#get-catmandu-sources"><span class="toc-section-number">8.5.3</span> Get Catmandu sources</a></li>
</ul></li>
<li><a href="#coding-guidelines"><span class="toc-section-number">8.6</span> Coding guidelines <a href="https://github.com/LibreCat/Catmandu/wiki/Coding%20guidelines">✎</a></a></li>
<li><a href="#compatibility"><span class="toc-section-number">8.7</span> Compatibility</a></li>
<li><a href="#code-documentation"><span class="toc-section-number">8.8</span> Code documentation</a></li>
<li><a href="#patch-submission"><span class="toc-section-number">8.9</span> Patch Submission <a href="https://github.com/LibreCat/Catmandu/wiki/Patch%20Submission">✎</a></a></li>
</ul></li>
<li><a href="#related-projects"><span class="toc-section-number">9</span> Related Projects <a href="https://github.com/LibreCat/Catmandu/wiki/Related%20Projects">✎</a></a><ul>
<li><a href="#selected-formats"><span class="toc-section-number">9.1</span> selected formats</a></li>
<li><a href="#general-frameworks"><span class="toc-section-number">9.2</span> general frameworks</a></li>
</ul></li>
</ul>
</nav>
<section id="introduction" class="level1">
<h1><span class="header-section-number">1</span> Introduction <a href="https://github.com/LibreCat/Catmandu/wiki/Introduction">✎</a></h1>
<p><strong>Catmandu</strong> is a command line tool to access and convert data from your digital library, research services or any other open data sets. The toolkit was originally developed as part of the <a href="#librecat">LibreCat</a> project and attracts now an international development team with many participating institutions.</p>
<p>Catmandu has the following features, one can:</p>
<ul>
<li>download data via protocols such as OAI-PMH, SRU, SPARQL and Linked Data Fragments.</li>
<li>convert formats library format such as MARC, MODS, Dublin Core and but also others like JSON, YAML, XML, Excel and many more.</li>
<li>generate RDF and speak the Semantic Web.</li>
<li>index data into databases such as Solr, Elasticsearch and MongoDB.</li>
<li>use a simple <a href="#fix-language">Fix language</a> to convert metadata into any format you like.</li>
</ul>
<p>Catmandu is used in the <a href="#librecat">LibreCat</a> project to build institutional repositories and search engines. Catmandu is used on the <a href="#-command-line-client">command line</a> for quick and dirty reports but also as part of larger programming projects processing millions of records per day. For a short overview of use-cases, see our <a href="http://librecat.org/use-cases.html">Homepage</a>.</p>
<p>There are more than 60 Catmandu projects available at <a href="https://github.com/organizations/LibreCat">GitHub LibreCat</a>.</p>
</section>
<section id="installation" class="level1">
<h1><span class="header-section-number">2</span> Installation <a href="https://github.com/LibreCat/Catmandu/wiki/Installation">✎</a></h1>
<p>To get Catmandu running on your system you need to download and install at least the CPAN <a href="https://metacpan.org/pod/Catmandu">Catmandu</a> module. Additional modules add support for more input and output formats, databases, and processing options.</p>
<p>To install Catmandu modules select at least Catmandu (and probably Catmandu::MARC, Catmandu::OAI, Catmandu::RDF, Catmandu::XLS)</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">sudo</span> cpanm Catmandu Catmandu::MARC</code></pre>
<p>To install extra Catmandu modules at any point in time, the <em>cpanm</em> command needs to be used.</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">sudo</span> cpanm  Catmandu::OAI
$ <span class="kw">sudo</span> cpanm  Catmandu::RDF
$ <span class="kw">sudo</span> cpanm  Catmandu::Store::MongoDB
$ <span class="kw">sudo</span> cpanm  Catmandu::XLS</code></pre>
<p>To make full usage of the capabilities of Catmandu, database and search engines such as MongoDB, Elasticsearch, Solr, Postgres, MySQL can be installed on the system with the corresponding Catmandu tools. How to install these database on your local system falls outside the scope of this documentation. Please consult the installation guide of the database product for more information. For more information on the available Catmandu packages consult our <a href="http://librecat.org/distributions.html">Distributions</a> list.</p>
<p>Here are some Catmandu installation hints for various platforms.</p>
<section id="debian" class="level3">
<h3><span class="header-section-number">2.0.1</span> Debian</h3>
<p>Several Catmandu packages are officially included in Debian but not all (see <a href="#voting-catmandu-packages-to-be-included-in-debian">Voting Catmandu packages to be included in Debian</a> and <a href="https://packages.debian.org/libcatmandu">this search</a> of currently available packages).</p>
<p>You can install all packages officially included in Debian:</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">sudo</span> apt-get update
<span class="kw">sudo</span> apt-get install libcatmandu*-perl</code></pre>
<p>Alternatively, you can build newest Catmandu and dependencies from source:</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">sudo</span> apt-get update
<span class="kw">sudo</span> apt-get install cpanminus build-essential libexpat1-dev libssl-dev libxml2-dev libxslt1-dev libgdbm-dev libmodule-install-perl
<span class="kw">cpanm</span> Catmandu Catmandu::MARC</code></pre>
<p>Alternatively, you can build newest Catmandu as unofficial packages, using most possible official packages:</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">sudo</span> apt update
<span class="kw">sudo</span> apt install dh-make-perl liblocal-lib-perl apt-file
<span class="kw">sudo</span> apt-file update
<span class="kw">sudo</span> apt install libtest-fatal-perl libmodule-build-tiny-perl libmoo-perl libmodule-pluggable-perl libcapture-tiny-perl libclass-load-perl libgetopt-long-descriptive-perl libio-tiecombine-perl libstring-rewriteprefix-perl libio-handle-util-perl
<span class="kw">cpan2deb</span> --vcs <span class="st">&#39;&#39;</span> MooX::Aliases
<span class="kw">cpan2deb</span> --vcs <span class="st">&#39;&#39;</span> Log::Any
<span class="kw">cpan2deb</span> --vcs <span class="st">&#39;&#39;</span> App::Cmd
<span class="kw">cpan2deb</span> --vcs <span class="st">&#39;&#39;</span> LaTeX::ToUnicode
<span class="kw">cpan2deb</span> --vcs <span class="st">&#39;&#39;</span> PICA::Data
<span class="kw">cpan2deb</span> --vcs <span class="st">&#39;&#39;</span> LV
<span class="kw">cpan2deb</span> --vcs <span class="st">&#39;&#39;</span> MODS::Record
<span class="kw">sudo</span> dpkg -i lib*-perl_*.deb
<span class="kw">cpan2deb</span> --vcs <span class="st">&#39;&#39;</span> BibTeX::Parser
<span class="kw">sudo</span> dpkg -i libbibtex-parser-perl_*.deb
<span class="kw">sudo</span> apt install libexporter-tiny-perl
<span class="kw">cpan2deb</span> --vcs <span class="st">&#39;&#39;</span> JSON::Path
<span class="kw">sudo</span> dpkg -i libjson-path-perl_*.deb
<span class="kw">cpan2deb</span> --vcs <span class="st">&#39;&#39;</span> JSON::Hyper
<span class="kw">sudo</span> dpkg -i libjson-hyper-perl_*.deb
<span class="kw">sudo</span> apt install libhttp-link-parser-perl libautovivification-perl libmatch-simple-perl
<span class="kw">cpan2deb</span> --vcs <span class="st">&#39;&#39;</span> JSON::Schema
<span class="kw">sudo</span> dpkg -i libjson-schema-perl_*.deb
<span class="kw">sudo</span> apt install libjson-xs-perl libtest-exception-perl libtest-deep-perl libfile-slurp-tiny-perl liburi-template-perl libtry-tiny-byclass-perl libdata-util-perl libdata-compare-perl libhash-merge-simple-perl libthrowable-perl libclone-perl libdata-uuid-perl libmarpa-r2-perl libconfig-onion-perl libmodule-info-perl libtext-csv-perl libcgi-expand-perl
<span class="kw">dh-make-perl</span> --vcs <span class="st">&#39;&#39;</span> --cpan Catmandu
<span class="kw">perl</span> -i -pe <span class="st">&#39;s/libossp-uuid-perl[^,\n]*/libdata-uuid-perl/g&#39;</span> libcatmandu-perl/debian/control
<span class="kw">(</span> <span class="kw">cd</span> libcatmandu-perl <span class="kw">&amp;&amp;</span> <span class="kw">dpkg-buildpackage</span> -b -us -uc -d <span class="kw">)</span>
<span class="kw">sudo</span> dpkg -i libcatmandu-perl_*.deb
<span class="kw">dh-make-perl</span> --vcs <span class="st">&#39;&#39;</span> --cpan Catmandu::Twitter
<span class="kw">perl</span> -i -pe <span class="st">&#39;s/liburi-perl\K[^,\n]*//g&#39;</span> libcatmandu-twitter-perl/debian/control
<span class="kw">(</span> <span class="kw">cd</span> libcatmandu-twitter-perl <span class="kw">&amp;&amp;</span> <span class="kw">dpkg-buildpackage</span> -b -us -uc -d <span class="kw">)</span>
<span class="kw">sudo</span> apt install libchi-perl libnet-ldap-perl libdatetime-format-strptime-perl libxml-libxslt-perl libxml-struct-perl libnet-twitter-perl libxml-parser-perl libspreadsheet-xlsx-perl libexcel-writer-xlsx-perl libdevel-repl-perl libio-pty-easy-perl
<span class="kw">cpan2deb</span> --recursive --vcs <span class="st">&#39;&#39;</span> Task::Catmandu
<span class="kw">sudo</span> apt install <span class="st">&#39;libcatmandu-*&#39;</span>
<span class="kw">sudo</span> dpkg -i libcatmandu-twitter-perl_*.deb
<span class="kw">sudo</span> dpkg -i ~/.cpan/build/libcatmandu-*-perl_*.deb</code></pre>
<section id="catmanduoai" class="level4 unnumbered">
<h4>Catmandu::OAI</h4>
<p>Alternatively, if you want to install as many packages as possible from the Debian repositories but also to have an additional package like <code>Catmandu::OAI</code>, you need to install packages and build just that module (with any dependency which would conflict if installed from the repositories):</p>
<pre><code>sudo apt-get install build-essential libcatmandu*-perl libexpat1-dev libssl-dev libxml2-dev libxslt1-dev libgdbm-dev libmodule-install-perl dh-make-perl liblocal-lib-perl apt-file libtest-fatal-perl libmodule-build-tiny-perl libmoo-perl libmodule-pluggable-perl libcapture-tiny-perl libclass-load-perl libgetopt-long-descriptive-perl libio-tiecombine-perl libstring-rewriteprefix-perl libio-handle-util-perl libtest-simple-perl libtest-needsdisplay-perl libtest-lwp-useragent-perl cpanminus
sudo cpanm Catmandu::OAI</code></pre>
<p>(Tested in Debian 8 / Jessie and Ubuntu 17.10. Compared to the advice above, we add <code>libtest-simple-perl libtest-needsdisplay-perl libtest-lwp-useragent-perl</code> and avoid <code>libhttp-oai-perl</code> which produces <code>Installed version (3.27) of HTTP::OAI is not in range '4.03'</code>.)</p>
</section>
</section>
<section id="ubuntu-server-12.04.4-lts" class="level3">
<h3><span class="header-section-number">2.0.2</span> Ubuntu Server 12.04.4 LTS</h3>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">apt-get</span> install make
<span class="kw">apt-get</span> install libmodule-install-perl
<span class="kw">apt-get</span> install libyaz-dev
<span class="kw">apt-get</span> install libwrap0-dev
<span class="kw">apt-get</span> install libxml2-dev zlib1g zlib1g-dev
<span class="kw">apt-get</span> install libexpat1-dev
<span class="kw">apt-get</span> install libxslt1-dev
<span class="kw">apt-get</span> install libssl-dev
<span class="kw">apt-get</span> install libgdbm-dev
<span class="kw">apt-get</span> install perl-doc
<span class="kw">yes</span> <span class="kw">|</span> <span class="kw">cpan</span> Test::More
<span class="kw">yes</span> <span class="kw">|</span> <span class="kw">cpan</span> YAML
<span class="kw">yes</span> <span class="kw">|</span> <span class="kw">cpan</span> App::cpanminus
<span class="kw">/usr/local/bin/cpanm</span> Catmandu Catmandu::MARC</code></pre>
</section>
<section id="centos-6.4" class="level3">
<h3><span class="header-section-number">2.0.3</span> CentOS 6.4</h3>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">yum</span> groupinstall <span class="st">&quot;Development Tools&quot;</span>
<span class="kw">yum</span> install perl-ExtUtils-MakeMaker
<span class="kw">yum</span> install perl-CPAN -y
<span class="kw">yum</span> install gcc -y
<span class="kw">yum</span> install gdbm gdbm-devel -y
<span class="kw">yum</span> install openssl-devel -y
<span class="kw">yum</span> install tcp_wrappers-devel -y
<span class="kw">yum</span> install expat expat-devel -y
<span class="kw">yum</span> install libxml2 libxml2-devel libxslt libxslt-devel -y
<span class="kw">yes</span> <span class="kw">|</span> <span class="kw">cpan</span> YAML
<span class="kw">yes</span> <span class="kw">|</span> <span class="kw">cpan</span> App::cpanminus
<span class="kw">/usr/local/bin/cpanm</span> Catmandu Catmandu::MARC</code></pre>
</section>
<section id="centos-7" class="level3">
<h3><span class="header-section-number">2.0.4</span> CentOS 7</h3>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">yum</span> group install <span class="st">&quot;Development Tools&quot;</span>
<span class="kw">yum</span> install perl-devel perl-YAML perl-CPAN perl-App-cpanminus -y
<span class="kw">yum</span> install openssl-devel tcp_wrappers-devel expat expat-devel libxml2 libxml2-devel libxslt libxslt-devel -y
<span class="kw">cpanm</span> autodie Catmandu Catmandu::MARC</code></pre>
</section>
<section id="opensuse" class="level3">
<h3><span class="header-section-number">2.0.5</span> openSUSE</h3>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">sudo</span> zypper install --type pattern devel_basis
<span class="kw">sudo</span> zypper install libxml2-devel libxslt-devel
<span class="kw">curl</span> -L http://cpanmin.us <span class="kw">|</span> <span class="kw">perl</span> - App::cpanminus  <span class="co">## unless you already have cpanm</span>
<span class="kw">cpanm</span> Catmandu Catmandu::MARC</code></pre>
</section>
<section id="openbsd-53" class="level3">
<h3><span class="header-section-number">2.0.6</span> OpenBSD 53</h3>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">cpan</span> App::cpanminus
<span class="kw">cpanm</span> Catmandu Catmandu::MARC</code></pre>
</section>
<section id="osx" class="level3">
<h3><span class="header-section-number">2.0.7</span> OSX</h3>
<p>Install XCode from the app store first and homebrew from https://brew.sh</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">brew</span> install libxml++ libxml2 xml2 libxslt
<span class="co"># Install plenv from https://github.com/tokuhirom/plenv</span>
<span class="kw">git</span> clone https://github.com/tokuhirom/plenv.git ~/.plenv
<span class="kw">echo</span> <span class="st">&#39;export PATH=&quot;$HOME/.plenv/bin:$PATH&quot;&#39;</span> <span class="kw">&gt;&gt;</span> ~/.bash_profile
<span class="kw">echo</span> <span class="st">&#39;eval &quot;$(plenv init -)&quot;&#39;</span> <span class="kw">&gt;&gt;</span> ~/.bash_profile
<span class="kw">exec</span> <span class="ot">$SHELL</span> -l
<span class="kw">git</span> clone https://github.com/tokuhirom/Perl-Build.git ~/.plenv/plugins/perl-build/
<span class="co"># Install a modern Perl</span>
<span class="kw">plenv</span> install 5.22.0
<span class="kw">plenv</span> rehash
<span class="kw">plenv</span> install-cpanm
<span class="kw">plenv</span> global 5.22.0

<span class="co"># Install catmandu</span>
<span class="kw">cpanm</span> Catmandu Catmandu::MARC
<span class="kw">plenv</span> rehash</code></pre>
</section>
<section id="windows-mac-osx-linux" class="level3">
<h3><span class="header-section-number">2.0.8</span> Windows, Mac OSX, Linux</h3>
<p>A <a href="https://registry.hub.docker.com/u/librecat/catmandu/">docker image of Catmandu</a> is build with each release. After <a href="https://docs.docker.com/installation/#installation">installation of docker</a> get and use the Catmandu image like this:</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="co"># Upgrade to the latest version</span>
<span class="kw">docker</span> pull librecat/catmandu

<span class="co"># Run the docker command</span>
<span class="kw">docker</span> run -it librecat/catmandu</code></pre>
<p>Or, in case you want a native install use <a href="http://strawberryperl.com/">Strawberry Perl</a>. Catmandu installations have been tested up to version 5.24.1.1. After installation of the EXE, reboot your machine, start the <code>cmd.exe</code> command line and execute:</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">cpanm</span> Catmandu Catmandu::MARC </code></pre>
</section>
<section id="raspbian-gnulinux-7-on-the-raspberry-pi-armhf" class="level3">
<h3><span class="header-section-number">2.0.9</span> Raspbian GNU/Linux 7 on the Raspberry Pi (armhf)</h3>
<p>Since Raspbian is based on Debian stable, you could follow the <a href="#debian">instructions there</a>. Unfortunately, you will run into timeouts, so it is advisable to install some prerequisites via apt-get first:</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">sudo</span> apt-get install libboolean-perl libdevel-repl-perl libnet-twitter-perl 
<span class="kw">sudo</span> apt-get install libxml-easy-perl libxslt1-dev libgdbm-dev</code></pre>
</section>
</section>
<section id="command-line-client" class="level1">
<h1><span class="header-section-number">3</span> Command line client <a href="https://github.com/LibreCat/Catmandu/wiki/Command%20line%20client">✎</a></h1>
<p>Most of the Catmandu processing doesn’t require you to write any code. With our command line tools you can store data files into databases, index your data, export data in various formats and provide basic data cleanup operations.</p>
<section id="convert" class="level4 unnumbered">
<h4>convert</h4>
<p>The <strong>convert</strong> command is used to transfrom one format to another, or to download data from the Internet. For example, to extract all titles from a MARC record one can write</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> convert MARC to CSV --fix <span class="st">&#39;marc_map(245a,title); retain(title)&#39;</span> <span class="kw">&lt;</span> data.mrc</code></pre>
<p>In the example above, we import MARC and export it again as CSV while extracting the 245a field from a record and deleting all the rest. With the <strong>convert</strong> command one can transform data from one format to another.</p>
<p>Transform JSON to YAML:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> convert JSON to YAML <span class="kw">&lt;</span> data.json</code></pre>
<p>Transform YAML to JSON:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> convert YAML to JSON <span class="kw">&lt;</span> data.json</code></pre>
<p>Convert Excel to CSV:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> convert XLS to CSV <span class="kw">&lt;</span> data.xls</code></pre>
<p>A <a href="#fix-language">Fix language</a> can be used to extract the fields from a input you are interested in:</p>
<p>Convert Excel to CSV and only keep the <em>titles</em>, <em>authors</em>, and <em>year</em> columns:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> convert XLS to CSV --fix <span class="st">&#39;retain(titles,authors,year)&#39;</span> <span class="kw">&lt;</span> data.xls</code></pre>
<p>In formats such as JSON or YAML the data can be deeply nested. All these fields can be accessed and converted.</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> convert JSON --fix <span class="st">&#39;upcase(my.nested.field.1)&#39;</span> <span class="kw">&lt;</span> data.xls</code></pre>
<p>In the example above a JSON input is converted by upcasing the field <em>my</em> that contains a field <em>nested</em> that contains a field <em>field</em> that contains a list for which the second item (indicated by <em>1</em>) should be upcased.</p>
<p>The convert command can also be used to extract data from a database. For example to download the Dublin Core data from the UGent institutional repository type:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> convert OAI --url http://biblio.ugent.be/oai</code></pre>
<p>To get a CSV export of all identifiers in this OAI-PMH service type:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> convert OAI --url http://biblio.ugent.be/oai to CSV --fix <span class="st">&#39;retain(_id)&#39;</span></code></pre>
<p>Or a YAML file with all titles:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> convert OAI --url http://biblio.ugent.be/oai --set public to YAML --fix <span class="st">&#39;retain(title)&#39;</span></code></pre>
</section>
<section id="import" class="level4 unnumbered">
<h4>import</h4>
<p>The <strong>import</strong> command is used to import data into a database. Catmandu provides support for NOSQL databases such as <a href="#-https://metacpan.org/pod/catmandu::store::mongodb">MongoDB</a>, <a href="#-https://metacpan.org/pod/catmandu::store::elasticsearch">Elasticsearch</a> and <a href="#-https://metacpan.org/pod/catmandu::store::couchdb">CouchDB</a> which require no preconfiguration before they can be used. There is also support for relational databases such as Oracle, MySQL and Postgres via <a href="#-https://metacpan.org/pod/catmandu::store::dbi">DBI</a> or search engines like <a href="#-https://metacpan.org/pod/catmandu::store::solr">Solr</a> but they need to be configured first (databases, tables, schemas need to be created first).</p>
<p>Importing a JSON document into MongoDB database can be as simple as:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> import JSON  to MongoDB --database_name bibliography <span class="kw">&lt;</span> books.json</code></pre>
<p>Importing into a database can be done for every format that is supported by Catmandu. For instance, MARC can be imported with this command:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> import MARC to MongoDB --database_name marc_data <span class="kw">&lt;</span> data.mrc</code></pre>
<p>Or, XLS</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> import XLS to MongoDB --database_name my_xls_data <span class="kw">&lt;</span> data.xls</code></pre>
<p>Even a download from a website can be directly stored into a database.</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> import -v OAI --url http://biblio.ugent.be/oai to MongoDB --database_name oai_data</code></pre>
<p>In the example above a copy of the institutional repository of Ghent University was loaded into a MongoDB database. Use the option <strong>-v</strong> to see a progress report.</p>
<p>Before the data is imported a Fix can be applied to extract fields or transform fields before they are stored into the database. For instance, we can extract the publication year from a MARC import and store this as a separate <em>year</em> field:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> import MARC to MongoDB --database_name marc_data --fix <span class="st">&#39;marc_map(&quot;008/7-10&quot;,year)&#39;</span> <span class="kw">&lt;</span> data.mrc</code></pre>
</section>
<section id="export" class="level4 unnumbered">
<h4>export</h4>
<p>The <strong>export</strong> command is used to retreive data from a database. See the <strong>import</strong> command above for a list of databases that are supported.</p>
<p>For instance we can export all the MARC records we have imported with this command:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> export MongoDB --database_name marc_data </code></pre>
<p>In case we only need the title field from the marc records and want the results in a CSV format we can add some fixes:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> export MongoDB --database_name marc_data to CSV --fix <span class="st">&#39;marc_map(245a,title); retain(title)&#39;</span></code></pre>
<p>Some database support a query syntax to query for records to be exported. For instance, in the example above we extracted the <em>year</em> field form the MARC import. This can be used to only export the records of a particular year:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> export MongoDB --database_name marc_data --query <span class="st">&#39;{&quot;year&quot;: &quot;1971&quot;}&#39;</span></code></pre>
</section>
<section id="configuration" class="level4 unnumbered">
<h4>configuration</h4>
<p>It is often handy to store the configuration options of importers, exporter and stores into a file. This allows you to create shorter easier commands. To do this a file ‘catmandu.yml’ needs to be created in your working directory with content like:</p>
<pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="ot">---</span>
<span class="fu">importer:</span>
  <span class="fu">ghent:</span>
     <span class="fu">package:</span> OAI
     <span class="fu">options:</span>
        <span class="fu">url:</span> http://biblio.ugent.be
        <span class="fu">set:</span> public
        <span class="fu">handler:</span> marcxml
        <span class="fu">metadataPrefix:</span> marc21
<span class="fu">store:</span>
  <span class="fu">ghentdb:</span>
     <span class="fu">package:</span> MongoDB
     <span class="fu">options:</span>
        <span class="fu">database_name:</span> oai_data
        <span class="fu">default_bag:</span> data</code></pre>
<p>When this file is available, an OAI-PMH harvest could be done with the shortened command:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> convert ghent</code></pre>
<p>To store the <em>ghent</em> OAI-PMH import into the MongoDB database, one could write:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> import ghent to ghentdb</code></pre>
<p>To extract the data from the database, one can write:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> export ghentdb</code></pre>
</section>
<section id="next" class="level4 unnumbered">
<h4>Next</h4>
<p>See the <a href="#command-line-client-cheat-sheet">Command line client Cheat Sheet</a> for more examples of command line commands.</p>
</section>
</section>
<section id="concepts" class="level1">
<h1><span class="header-section-number">4</span> Concepts <a href="https://github.com/LibreCat/Catmandu/wiki/Concepts">✎</a></h1>
<p>To better make use of Catmandu is helps to first understand its <strong>core concepts</strong>:</p>
<p><strong><a href="#items">Items</a></strong> are the basic unit of data processing in Catmandu. Items can be read, stored, and accessed in many formats. An item can be a MARC record or a RDF triple or one row in an Excel file.</p>
<p><strong><a href="#importers">Importers</a></strong> are used to read items. There are importers for MARC, JSON, YAML, CSV, Excel, and many other input formats. One can also import from remote sources such as SPARQL, Atom and OAI-PMH endpoints.</p>
<p><strong><a href="#exporters">Exporters</a></strong> are used to transform items back into JSON, YAML, CSV, Excel or any format you like.</p>
<p><strong><a href="#stores">Stores</a></strong> are database to store your data. With database such MongoDB and ElasticSearch it becomes really, really easy to store quite complicated, deeply nested, items.</p>
<p><strong><a href="#fixes">Fixes</a></strong> transforms items, transform the data into any format you like. See <a href="#fix-language">Fix language</a> and <a href="#fix-packages">Fix packages</a> for details.</p>
<section id="items" class="level2">
<h2><span class="header-section-number">4.1</span> Items <a href="https://github.com/LibreCat/Catmandu/wiki/Items">✎</a></h2>
<p>An <strong>item</strong> is the basic unit of data processing in Catmandu. Items are data structures build of key-value-pairs (aka objects), lists (aka arrays), strings, numbers, and null-values. All items can be expressed in <a href="http://json.org">JSON</a> and YAML, among other formats.</p>
<p>Internally all data processing by Catmandu is using a generic data format not unlike JSON. If one imports MARC, XML, Excel, OAI-PMH, SPARQL, data from a database or any other format, everything can be expressed as JSON.</p>
<p>For example:</p>
<ul>
<li>JSON/YAML - when importing a large JSON/YAML collections as an array, every item is a Catmandu item.</li>
<li>Text - for text import every line of text is one Catmandu item.</li>
<li>MARC - when importing MARC data, every record in a MARC file is one Catmandu item.</li>
<li>XLS,CSV - for tabular formats such as Excel, CSV and TSV, each row in a table is one Catmandu item</li>
<li>RDF - for linked data formats such as RDF/XML, RDF/nTriples, RDF/Turtle each triple is one Catmandu item</li>
<li>SPARQL - for a result set of a SPARQL or LDF query, every result (with the variable bindings) is one Catmandu item</li>
<li>MongoDB,ElasticSearch,Solr,DBI - for databases every record in the database is one Catmandu item</li>
</ul>
<p>To transform items with the <a href="#fix-language">Fix language</a> one points to the fields in items with a <a href="http://goessner.net/articles/JsonPath/">JSONPath</a> expression (Catmandu uses an extension of JSONPath actually). The fixes provided to a catmandu command operate on all individual items.</p>
<p>For instance, the command below will upcase the <em>publisher</em> field for every item (row) in the <em>data.xls</em> file:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> convert XLS --fix <span class="st">&#39;upcase(publisher)&#39;</span> <span class="kw">&lt;</span> data.xls</code></pre>
<p>This command will select only the JSON items that contain ‘Tsjechov’ in a nested <em>authors</em> field:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> convert XLS --fix <span class="st">&#39;select any_match(authors.*,&quot;Tsjechov.*&quot;)&#39;</span> <span class="kw">&lt;</span> data.json</code></pre>
<p>This command will delete all the uppercase A characters from a Text file:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> convert Text to Text --fix <span class="st">&#39;replace_all(A,&quot;&quot;)&#39;</span> <span class="kw">&lt;</span> data.txt</code></pre>
<p>To see the internal representation of a MARC file in Catmandu, transform it for instance to YAML</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> convert MARC to YAML <span class="kw">&lt;</span> data.mrc</code></pre>
<p>One will see that a MARC record is treated as an array of arrays for each item.</p>
</section>
<section id="importers" class="level2">
<h2><span class="header-section-number">4.2</span> Importers <a href="https://github.com/LibreCat/Catmandu/wiki/Importers">✎</a></h2>
<p>Importers are Catmandu packages to read a specific data format. Catmandu provides importers for MARC, JSON, YAML, CSV, Excel, and many other input formats. One can also import from remote sources for instance via protocols such as SPARQL and OAI-PMH.</p>
<p>The name of a Catmandu importer should be provided as first argument to the <strong>convert</strong> command.</p>
<p>Read JSON input:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> convert JSON</code></pre>
<p>Read YAML input</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> convert YAML</code></pre>
<p>Read MARC input</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> convert MARC</code></pre>
<p>The Importer accepts configurable options. The following arguments to the MARC importer are currently supported: * <code>USMARC</code> (use <code>ISO</code> as an alias) * <code>MicroLIF</code> * <code>MARCMaker</code> * <code>MiJ</code> (for MARC-in-JSON) * <code>XML</code> (for MARCXML) * <code>RAW</code> * <code>Lint</code> * <code>ALEPHSEQ</code>(for Aleph Sequential)</p>
<p>Read MARC-XML input</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> convert MARC --type XML <span class="kw">&lt;</span> marc.xml</code></pre>
<p>Read Aleph sequential input</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> convert MARC --type ALEPHSEQ <span class="kw">&lt;</span> marc.txt</code></pre>
<p>Read more about the configuration options of importers by reading their manual pages:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> help import JSON
$ <span class="kw">catmandu</span> help import YAML</code></pre>
</section>
<section id="exporters" class="level2">
<h2><span class="header-section-number">4.3</span> Exporters <a href="https://github.com/LibreCat/Catmandu/wiki/Exporters">✎</a></h2>
<p><strong>Exporters</strong> are Catmandu packages to export data in specific format. See <a href="#importers">Importers</a> for the opposite action.</p>
<p>Some exporter such as JSON and YAML can handle any type of input. It doesn’t matter how the input is structured, it is always possible to create a JSON or YAML file.</p>
<p>Exporter are given after the <em>to</em> argument to the <em>convert</em> command</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> convert OAI --url http://biblio.ugent.be/oai to JSON
$ <span class="kw">catmandu</span> convert MARC to JSON
$ <span class="kw">catmandu</span> convert XLS to JSON</code></pre>
<p>For most exporters however, the input data needs to be structured in a specific format. For instance, tabular formats such as Excel, CSV and TSV don’t allow for nested fields. In the example below, catmandu tried to convert a list into a simple value which will fail:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">echo</span> <span class="st">&#39;{&quot;colors&quot;:[&quot;red&quot;,&quot;green&quot;,&quot;blue&quot;]}&#39;</span> <span class="kw">|</span> <span class="kw">catmandu</span> convert JSON to CSV
<span class="kw">colors</span>
<span class="kw">ARRAY</span>(0x7f8885a16a50)</code></pre>
<p>The is an <em>ARRAY</em> output, indicating that the colors field is nested. To fix this, a transformation needs to be provided:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">echo</span> <span class="st">&#39;{&quot;colors&quot;:[&quot;red&quot;,&quot;green&quot;,&quot;blue&quot;]}&#39;</span> <span class="kw">|</span> <span class="kw">catmandu</span> convert JSON to CSV --fix <span class="st">&#39;join_field(colors,&quot;,&quot;)&#39;</span>
<span class="kw">colors</span>
<span class="st">&quot;red,green,blue&quot;</span></code></pre>
<p>MARC output should have an input in the Catmandu MARC format, RDF exports need the <a href="https://metacpan.org/pod/RDF::aREF">aREF</a> format, etc etc.</p>
<p>Exporter also accept options to configure the various kinds of exports. For instance, JSON can be exporter in a array or line by line format</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> convert MARC to JSON --array 1 <span class="kw">&lt;</span> data.mrc
$ <span class="kw">catmandu</span> convert MARC to JSON --line_delimited 1 <span class="kw">&lt;</span> data.mrc
$ <span class="kw">catmandu</span> convert MARC to JSON --pretty 1 <span class="kw">&lt;</span> data.mrc</code></pre>
<p>The <a href="https://metacpan.org/pod/Catmandu::Template">Catmandu::Template</a> package can be used to generate any type of structured output given an input using the <a href="http://template-toolkit.org/">Template Toolkit</a> language.</p>
<p>For instance, to create a JSON array of colors an <em>echo</em> command can used on Linux:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">echo</span> <span class="st">&#39;{&quot;colors&quot;:[&quot;red&quot;,&quot;green&quot;,&quot;blue&quot;]}&#39;</span></code></pre>
<p>To transform this JSON into XML, the Template exporter can be used with a template file as a command line argument:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">echo</span> <span class="st">&#39;{&quot;colors&quot;:[&quot;red&quot;,&quot;green&quot;,&quot;blue&quot;]}&#39;</span> <span class="kw">|</span> <span class="kw">catmandu</span> convert JSON to Template --template <span class="kw">`pwd`</span>/xml.tt</code></pre>
<p>and <em>xml.tt</em> like:</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">&lt;colors&gt;</span>
[<span class="kw">%</span> FOREACH c IN colors %]
  <span class="kw">&lt;color&gt;</span>[% c %]<span class="kw">&lt;</span>/color<span class="kw">&gt;</span>
[<span class="kw">%</span> END %]
<span class="kw">&lt;</span>/<span class="kw">colors&gt;</span></code></pre>
<p>will produce:</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">&lt;colors&gt;</span>
  <span class="kw">&lt;color&gt;</span>red<span class="kw">&lt;</span>/color<span class="kw">&gt;</span>
  <span class="kw">&lt;color&gt;</span>green<span class="kw">&lt;</span>/color<span class="kw">&gt;</span>
  <span class="kw">&lt;color&gt;</span>blue<span class="kw">&lt;</span>/color<span class="kw">&gt;</span>
<span class="kw">&lt;</span>/<span class="kw">colors&gt;</span></code></pre>
<p>Consult the manual pages of catmandu to see the output options of the different Exporters:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> help export JSON
$ <span class="kw">catmandu</span> help export YAML
$ <span class="kw">catmandu</span> help export CSV</code></pre>
</section>
<section id="stores" class="level2">
<h2><span class="header-section-number">4.4</span> Stores <a href="https://github.com/LibreCat/Catmandu/wiki/Stores">✎</a></h2>
<p><strong>Store</strong> are Catmandu packages to store Catmandu <a href="#items">Items</a> in a database. These databases need to be installed separately from Catmandu. Special database such as MongoDB, ElasticSearch and CouchDB can work out-of-the-box with hardly any configuration. For other databases such as Solr, MySQL, Postgres and Oracle extra configuration steps are needed to define the database schemas.</p>
<p>Catmandu stores such as MongoDB, ElasticSearch and CouchDB can accept any type of input. They are perfect tools to store the output of data conversions.</p>
<p>Without defining any database schema, JSON, YAML , MARC, Excel, CSV, OAI-PMH or any other Catmandu supported format can be stored.</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> import JSON to MongoDB --database_name test <span class="kw">&lt;</span> data.json
$ <span class="kw">catmandu</span> import YAML to MongoDB --database_name test <span class="kw">&lt;</span> data.yml
$ <span class="kw">catmandu</span> import MARC to MongoDB --database_name test <span class="kw">&lt;</span> data.mrc
$ <span class="kw">catmandu</span> import XLS to MongoDB --database_name test  <span class="kw">&lt;</span> data.xls</code></pre>
<p>Many Catmandu stores can be queried with their native query language:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> export MongoDB --database_name test --query <span class="st">&#39;{&quot;my.deep.field&quot;:&quot;abc&quot;}&#39;</span></code></pre>
<p>To delete data from a store the <strong>delete</strong> command can be used.</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="co"># Delete everything</span>
$ <span class="kw">catmandu</span> delete MongoDB --database_name test  
<span class="co"># Delete record with _id = 1234 and _id = 1235</span>
$ <span class="kw">catmandu</span> delete MongoDB --database_name test --id 1234 --id 1235</code></pre>
<p>Use the <strong>count</strong> command to show the size of a database.</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> count MongoDB --database_name test  </code></pre>
<p>One important use-case for Catmandu is indexation of data in search engines such as Solr. To do this, Solr needs to be configured for the fields you want to make searchable. Your data collection can be indexed in the Solr engine by mapping the fields in your data to the fields available in Solr.</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> import MARC to Solr --fix marc2solr.fix <span class="kw">&lt;</span> data.mrc</code></pre>
<p>where <em>marc2solr.fix</em> is a Fix script containing all the fixes required to transform your input data in the Solr format:</p>
<pre><code># marc2solr.fix
marc_map(&#39;008_/7-10&#39;,&#39;year&#39;)
marc_map(&#39;020a&#39;,&#39;isbn.$append&#39;)
marc_map(&#39;022a&#39;,&#39;issn.$append&#39;)
marc_map(&#39;245a&#39;,&#39;title_short&#39;)
.
.
.</code></pre>
<p>In reality the Fix script will contain many mappings and data transformations to clean data. See <a href="#example-fix-script">Example Fix Script</a> for a long example of such a data cleaning in action.</p>
</section>
<section id="filestore" class="level2">
<h2><span class="header-section-number">4.5</span> FileStore <a href="https://github.com/LibreCat/Catmandu/wiki/FileStore">✎</a></h2>
<p><a href="#stores">Stores</a> are Catmandu packages to store Catmandu <a href="#items">Items</a> in a database. A <strong>FileStore</strong> is a Store where you can store binary content (unstructured data). Out of the box, one FileStore implementation is provided: <strong>File::Simple</strong> which stores files in a directory structure on the local file system.</p>
<p>The command below stores the <code>/tmp/myfile.txt</code> in the <code>File::Simple</code> FileStore in the “container” <code>1234</code> with the file identifier <code>myfile.txt</code>:</p>
<pre class="(bash)"><code>$ catmandu stream /tmp/myfile.txt to File::Simple --root t/data --bag 1234 --id myfile.txt</code></pre>
<p>The <code>root</code> parameter is mandatory for the <code>File::Simple</code> FileStore. It defines the location where all stored files are written. The other two parameters <code>bag</code> and <code>id</code> are mandatory for every FileStore (see below).</p>
<p>To extract a file from a FileStore the <code>stream</code> command can be used in the opposite direction:</p>
<pre class="(bash)"><code>$ catmandu stream File::Simple --root t/data --bag 1234 --id myfile.txt to /tmp/myfile.txt</code></pre>
<p>From the <code>File::Simple</code> the file <code>myfile.txt</code> is extracted from the container with identifier <code>1234</code>.</p>
<p>Every FileStore inherits the functionality of a Store. In this way the <code>drop</code> and <code>delete</code> commands can be used to delete data from a FileStore:</p>
<pre class="(bash)"><code># Delete a &quot;file&quot;
$ catmandu delete File::Simple --root t/data --bag 1234 --id myfile.txt

# Delete a &quot;folder&quot;
$ catmandu drop File::Simple --root t/data --bag 1234</code></pre>
<section id="bag" class="level3">
<h3><span class="header-section-number">4.5.1</span> Bag</h3>
<p>A FileStore contains one or more <strong>Bag</strong>s. These Bags are containers (or “folders”) to store zero or more files. The name of these container, indicated with the <code>bag</code> option in the Catmandu commands, is an identifier. In the case of the <code>File::Simple</code> this identifier needs to be a number, or when setting the <code>uuid</code> option a UUID identifier.</p>
<p>The binary data (files) stored in these Bags also needs an identifier, indicated with the <code>id</code> option. Usually the file name is a good choice to use.</p>
<p>Both the <code>bag</code> name option and <code>id</code> options are required when uploading or streaming data from a FileStore.</p>
<p>Within a FileStore Bag there is no deeper hierarchy possible. A Bag contains a flat list of files. To store deeply nested folders and files, mechanisms such as ZIP files need to be created and imported.</p>
<pre class="(bash)"><code>$ zip -r /tmp/files.zip /mnt/data/files
$ catmandu stream /tmp/files.zip --root t/data --bag 1234 --id files.zip</code></pre>
</section>
<section id="index" class="level3">
<h3><span class="header-section-number">4.5.2</span> Index</h3>
<p>Every FileStore has a default Bag called <code>index</code> which contains a list of all available Bags in the store (like the listing of all folders). Using the <code>export</code> command a listing of bags can be requested from the FileStore:</p>
<pre><code>$ catmandu export File::Simple --root t/data to YAML</code></pre>
<p>To retrieve a listing of all files stored in a bag the <code>bag</code> option needs to be provided:</p>
<pre><code>$ catmandu export File::Simple --root t/data --bag 1234 to YAML</code></pre>
</section>
<section id="technical-metadata" class="level3">
<h3><span class="header-section-number">4.5.3</span> Technical Metadata</h3>
<p>Each Bag (“container”) in a FileStore contains at least the <code>_id</code> as metadata. Some FileStores may contain more metadata. To retrieve a listing of all containers use the <code>export</code> command on the FileStore:</p>
<pre class="(bash)"><code>$ catmandu export File::Simple --root t/data 
[{&quot;_id&quot;:&quot;1234&quot;},{&quot;_id&quot;:&quot;1235&quot;},{&quot;_id&quot;:&quot;1236&quot;}]</code></pre>
<p>Every “file” in a FileStore contains at least the following fields:</p>
<ul>
<li>**_id** : the name of the file</li>
<li>**_stream** : a callback function to download the contents of the file (pass it an IO::Handle)</li>
<li><strong>created</strong> : the creation date time of the file as a UNIX timestamp</li>
<li><strong>modified</strong> : the last modification date time of the file as a UNIX timestamp</li>
<li><strong>content_type</strong> : the content type of the file</li>
<li><strong>size</strong> : the file size in bytes</li>
<li><strong>md5</strong> : an MD5 checksum if the FileStore support is, or an empty string</li>
</ul>
<p>NOTE: Not every exporter can serialise the code reference in the <code>stream</code> field. For instance, when exporting to JSON this error message will be show up:</p>
<pre class="(bash)"><code>$ catmandu export File::Simple --root t/data --bag 1234
Oops! encountered CODE(0x7f99685f4390), but JSON can only represent references to arrays or hashes at /Users/hochsten/.plenv/versions/5.24.0/lib/perl5/site_perl/5.24.0/Catmandu/Exporter/JSON.pm line 36.</code></pre>
<p>This field can be ignored from the output using the <code>remove_field</code> fix:</p>
<pre class="(bash)"><code>$ catmandu export File::Simple --root t/data --bag 1234 --fix &#39;remove_field(_stream)&#39;
[{&quot;_id&quot;:&quot;files.pdf&quot;,&quot;content_type&quot;:&quot;application/pdf&quot;,&quot;modified&quot;:1498122646,&quot;md5&quot;:&quot;&quot;,&quot;size&quot;:883202,&quot;created&quot;:1498122646}]</code></pre>
<p>Always use the <code>stream</code> command in Catmandu to extract files from a FileStore:</p>
<pre class="(bash)"><code>$ catmandu stream File::Simple --root t/data --bag 1234 --id &#39;files.pdf&#39; &gt; output.pdf</code></pre>
</section>
<section id="configuration-1" class="level3">
<h3><span class="header-section-number">4.5.4</span> Configuration</h3>
<p>As for Stores, the configuration parameters for FileStore can be written in a <code>catmandu.yml</code> configuration file. In this way the Catmandu commands can be shortened:</p>
<pre><code>$ cat catmandu.yml
---
store:
  files
    package: File::Simple
    options:
        root: t/data

# Get a &quot;directory&quot; listing
$ catmandu export files to YAML

# Get a &quot;file&quot; listing
$ catmandu export files --bag 1234 to YAML

# Add a file
$ catmandu stream /tmp/myfile.txt to files --bag 1234 --id myfile.txt

# Download a file
$ catmandu stream files --bag 1234 --id myfile.txt to /tmp/myfile.txt
</code></pre>
</section>
</section>
<section id="fixes" class="level2">
<h2><span class="header-section-number">4.6</span> Fixes <a href="https://github.com/LibreCat/Catmandu/wiki/Fixes">✎</a></h2>
<p><strong>Fixes</strong> are used for easy data transformations by non programmers. Using a small <a href="#fix-language">Fix language</a> non-programmers can manipulate Catmandu <a href="#-items">Items</a>.</p>
<p>To introduce the capabilities of Fix, an example will be provided below to extract data from a MARC input.</p>
<p>First, make sure that Catmandu::MARC is installed on your system.</p>
<pre><code> $ sudo cpanm Catmandu::MARC</code></pre>
<p>We will use the Catmandu <a href="#command-line-client">command line client</a> to extract data from an example USMARC file that can be downloaded via this: <a href="#-files/camel.usmarc">link</a> - <code>camel.usmarc</code>.</p>
<p>With the <code>convert</code> command one can read items from a MARC <a href="#-importers">Importer</a> and convert it into a new format. By default, convert will output JSON:</p>
<pre><code>$ catmandu convert MARC &lt; camel.usmarc
{&quot;record&quot;:[[&quot;LDR&quot;,null,null,&quot;_&quot;,&quot;00755cam  22002414a 4500&quot;],[&quot;001&quot;,null,null...
...
[&quot;650&quot;,&quot; &quot;,&quot;0&quot;,&quot;a&quot;,&quot;Cross-platform software development.&quot;]],&quot;_id&quot;:&quot;fol05882032 &quot;}</code></pre>
<p>You can make this conversion explicit:</p>
<pre><code>$ catmandu convert MARC to JSON &lt; camel.usmarc</code></pre>
<p>To transform this MARC data we first will create a Fix file which contains all the Fix commands we will use. Create a text file ‘fixes.txt’ on your system with this input:</p>
<pre><code>remove_field(&#39;record&#39;);</code></pre>
<p>and execute the following command:</p>
<pre><code>$ catmandu convert MARC --fix fixes.txt &lt; camel.usmarc
{&quot;_id&quot;:&quot;fol05731351 &quot;}
{&quot;_id&quot;:&quot;fol05754809 &quot;}
{&quot;_id&quot;:&quot;fol05843555 &quot;}
{&quot;_id&quot;:&quot;fol05843579 &quot;}</code></pre>
<p>We have removed the field ‘record’ (containing the MARC data) from the JSON record. This is what the ‘remove_field’ Fix does: remove one field in a JSON record. We will use this remove_field(‘record’) to make our output a bit more terse and easier readable.</p>
<p>With the ‘marc_map’ Fix from the Catmandu::MARC package we can extract MARC (sub)fields from the record. Add these to the fixes.txt file:</p>
<pre><code>marc_map(&#39;245&#39;,&#39;title&#39;);
remove_field(&#39;record&#39;);</code></pre>
<p>When we run our previous catmandu command we get the following output:</p>
<pre><code>$ catmandu convert MARC --fix fixes.txt to JSON --line_delimited 1 &lt; camel.usmarc
{&quot;_id&quot;:&quot;fol05731351 &quot;,&quot;title&quot;:&quot;ActivePerl with ASP and ADO /Tobias Martinsson.&quot;}
{&quot;_id&quot;:&quot;fol05754809 &quot;,&quot;title&quot;:&quot;Programming the Perl DBI /Alligator Descartes and Tim Bunce.&quot;}
{&quot;_id&quot;:&quot;fol05843555 &quot;,&quot;title&quot;:&quot;Perl :programmer&#39;s reference /Martin C. Brown.&quot;}</code></pre>
<p>We know that in the 650-a field of MARC we can find subjects. Lets add them to the fixes.txt:</p>
<pre><code>marc_map(&#39;245&#39;,&#39;title&#39;);
marc_map(&#39;650a&#39;,&#39;subject&#39;);
remove_field(&#39;record&#39;);</code></pre>
<p>and run the command again:</p>
<pre><code>$ catmandu convert MARC --fix fixes.txt to JSON --line_delimited 1 &lt; camel.usmarc
{&quot;subject&quot;:&quot;Perl (Computer program language)&quot;,&quot;_id&quot;:&quot;fol05731351 &quot;,&quot;title&quot;:&quot;ActivePerl with ASP and ADO /Tobias Martinsson.&quot;}
{&quot;subject&quot;:&quot;Perl (Computer program language)Database management.&quot;,&quot;_id&quot;:&quot;fol05754809 &quot;,&quot;title&quot;:&quot;Programming the Perl DBI /Alligator Descartes and Tim Bunce.&quot;}
{&quot;subject&quot;:&quot;Perl (Computer program language)&quot;,&quot;_id&quot;:&quot;fol05843555 &quot;,&quot;title&quot;:&quot;Perl :programmer&#39;s reference /Martin C. Brown.&quot;}</code></pre>
<p>The MARC 008 field from position 7 to 10 contains publication years. We can also add these to the ‘fixes.txt’ file:</p>
<pre><code>marc_map(&#39;245&#39;,&#39;title&#39;);
marc_map(&#39;650a&#39;,&#39;subject&#39;);
marc_map(&#39;008/7-10,&#39;year&#39;);
remove_field(&#39;record&#39;);</code></pre>
<p>and run the command:</p>
<pre><code>$ catmandu convert MARC --fix fixes.txt to JSON --line_delimited 1 &lt; camel.usmarc
{&quot;subject&quot;:&quot;Perl (Computer program language)&quot;,&quot;_id&quot;:&quot;fol05731351 &quot;,&quot;title&quot;:&quot;ActivePerl with ASP and ADO /Tobias Martinsson.&quot;,&quot;year&quot;:&quot;2000&quot;}
{&quot;subject&quot;:&quot;Perl (Computer program language)Database management.&quot;,&quot;_id&quot;:&quot;fol05754809 &quot;,&quot;title&quot;:&quot;Programming the Perl DBI /Alligator Descartes and Tim Bunce.&quot;,&quot;year&quot;:&quot;2000&quot;}
{&quot;subject&quot;:&quot;Perl (Computer program language)&quot;,&quot;_id&quot;:&quot;fol05843555 &quot;,&quot;title&quot;:&quot;Perl :programmer&#39;s reference /Martin C. Brown.&quot;,&quot;year&quot;:&quot;1999&quot;}</code></pre>
<p>You don’t need to write fixes into a file to use them. E.g. if we want to have some statistic on the publication year in the camel.usmarc file we can do something like:</p>
<pre><code>$ catmandu convert MARC --fix &quot;marc_map(&#39;008/7-10&#39;,&#39;year&#39;); retain_field(&#39;year&#39;)&quot; to CSV &lt; camel.usmarc
year
2000
2000
1999
.
.</code></pre>
<p>With marc_map we extracted the year form the 008 field. With retain_field we deleted everything in the output except for the field ‘year’. We used the CSV <a href="#-exporters">Exporter</a> to present the results in an easy format.</p>
</section>
</section>
<section id="fix-language" class="level1">
<h1><span class="header-section-number">5</span> Fix language <a href="https://github.com/LibreCat/Catmandu/wiki/Fix%20language">✎</a></h1>
<p>Catmandu comes with a small domain specific language for manipulation of data <a href="#items">items</a> called <strong>Fix</strong>. The <strong>Fix</strong> consists of</p>
<ul>
<li><em><a href="#paths">Paths</a></em> to refer to particular parts of an item</li>
<li><em><a href="#functions">Functions</a></em> to manipulate (parts of) an item</li>
<li><em><a href="#selectors">Selectors</a></em> to manipulate which items end up in the end result</li>
<li><em><a href="#conditionals">Conditionals</a></em> to control when to apply which Fix functions</li>
<li><em><a href="#binds">Binds</a></em> to manipulate the execution of Fix functions</li>
<li><em><a href="#comments">Comments</a></em> to provide documentation in the Fix script</li>
</ul>
<section id="paths" class="level2">
<h2><span class="header-section-number">5.1</span> Paths <a href="https://github.com/LibreCat/Catmandu/wiki/Paths">✎</a></h2>
<section id="paths-1" class="level4 unnumbered">
<h4>Paths</h4>
<p>Almost any transformation on a Catmandu item contains a path to the part of the item that needs to be changed. To upcase the <em>title</em> field in an item the Fix <em>upcase</em> need to be used:</p>
<pre><code>upcase(title)</code></pre>
<p>A field can be nested in <strong>key-value-pairs</strong> (objects). To access the field deep in a key-value-pair, the <strong>dot-notation</strong> should be used:</p>
<pre><code>upcase(my.deep.nested.title)</code></pre>
<p>If a part of an item contains a <strong>list</strong> of fields than the <strong>index-notation</strong> should be used. Use index 0 to point to the first item in a list, index 1 to point to the second item in a list, index 3 to the third, etc, etc.</p>
<pre><code>upcase(my.data.2.title)  # upcase the title of the 3rd item in the my.data list</code></pre>
<p>For example, given this YAML input:</p>
<pre class="sourceCode yaml"><code class="sourceCode yaml">___
<span class="fu">title:</span> My Little Pony
<span class="fu">my:</span>
 <span class="fu">colors:</span>
   <span class="kw">-</span> red
   <span class="kw">-</span> green
   <span class="kw">-</span> blue
 <span class="fu">nested:</span>
     <span class="fu">a:</span>
      <span class="fu">b:</span>
       <span class="fu">c:</span> Hoi!</code></pre>
<p>The value ‘My Little Pony’ can be accessed using the path:</p>
<pre><code>title</code></pre>
<p>The value ‘green’ can be accessed using the path:</p>
<pre><code>my.colors.1 </code></pre>
<p>The value ‘Hoi!’ can be accessed using the path:</p>
<pre><code>my.nested.a.b.c  </code></pre>
</section>
<section id="wildcards" class="level3">
<h3><span class="header-section-number">5.1.1</span> Wildcards</h3>
<p>Wildcards are used to point to relative positions or many positions in a list.</p>
<p>To point to the <strong>first item</strong> in a list (e.g. the value ‘red’ in the example above) the wildcard <em>$first</em> can be used:</p>
<pre><code>my.colors.$first </code></pre>
<p>To point to the <strong>last item</strong> in a list (e.g. the value ‘blue’ in the example above) the wildcard <em>$last</em> can be used:</p>
<pre><code>my.colors.$last </code></pre>
<p>In some cases, one needs to point to a position <strong>before the first item</strong> in a list. For instance, add a new field before the color ‘red’ in our example above, the wildcard ‘$prepend’ should be used:</p>
<pre><code>my.colors.$prepend</code></pre>
<p>This wildcard can be used in the functions like <strong>set_field</strong>:</p>
<pre><code>set_field(my.colors.$prepend,&#39;pink&#39;)</code></pre>
<p>To add a new field add the end of a list (after the color ‘blue’), the wildcard ‘$append’ should be used:</p>
<pre><code>my.colors.$append</code></pre>
<p>As in:</p>
<pre><code>set_field(my.colors.$append,&#39;yellow&#39;)</code></pre>
<p>The <strong>star notation</strong> is used to point to <strong>all</strong> the items in a list:</p>
<pre><code>my.colors.*</code></pre>
<p>To upcase all the colors use:</p>
<pre><code>upcase(my.colors.*)</code></pre>
<p>When lists are nested inside lists, then wildcards can also be nested:</p>
<pre><code>my.*.colors.*</code></pre>
<p>The above trick can be used when the <em>my</em> field contains a list which contains a <em>color</em> field which contains again a list of data. E.g.</p>
<pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="ot">---</span>
<span class="fu">my:</span>
 <span class="kw">-</span> <span class="fu">colors:</span>
     <span class="kw">-</span> red
     <span class="kw">-</span> blue
 <span class="kw">-</span> <span class="fu">colors:</span>
     <span class="kw">-</span> yellow
     <span class="kw">-</span> green</code></pre>
</section>
<section id="marc-mab-pica-paths" class="level3">
<h3><span class="header-section-number">5.1.2</span> MARC, MAB, PICA paths</h3>
<p>For some data formats is can be quite difficult to extract data by the exact position of a field. In data formats such as MARC, one is unsually not interested in a field in the 17th position which contains a subfield in position 3. MARC contains tags and subfields, which can be at any position in the MARC record.</p>
<p>Specialized Fix functions for MARC, MAB and PICA make it easier to access data by changing the Path syntax. For instance, to copy the 245a field in a MARC record to the <em>title</em> field one can write:</p>
<pre><code>marc_map(&quot;245a&quot;,title)</code></pre>
<p>In the context of a <em>marc_map</em> Fix the “245a” Path is a <strong>MARC Path</strong> that points to a part of the MARC record. These MARC Paths only work in MARC Fixes (<em>marc_map</em>, <em>marc_add</em>, <em>marc_set</em>, <em>marc_remove</em>). It is not possible to use these paths in other Catmandu fix functions:</p>
<pre><code>marc_map(&quot;245a&quot;,title)            # This will work
copy_field(&quot;246a&quot;,&quot;other_title&quot;)  # This will NOT work</code></pre>
<p>Consult the documentation of the different specialised packages for the Path syntax that can be used.</p>
</section>
</section>
<section id="functions" class="level2">
<h2><span class="header-section-number">5.2</span> Functions <a href="https://github.com/LibreCat/Catmandu/wiki/Functions">✎</a></h2>
<p><strong>Fix functions</strong> manipulate fields in every item of a Catmandu <a href="#-importers">Importer</a>. For instance, using the command below the <em>title</em> field will be upcased for every item in the input list of JSON items.</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> convert JSON --fix <span class="st">&#39;upcase(title)&#39;</span> <span class="kw">&lt;</span> data.json</code></pre>
<p>Fix functions can have zero or more <strong>arguments</strong> separated by commas:</p>
<pre><code>vacuum()              # Clean all empty fields in a record
upcase(title)         # Upcase the title value
append(title,&quot;-123&quot;)  # Add -123 at the end of the title value </code></pre>
<p>The arguments to a Fix function can be a <strong>Fix path</strong> or a <strong>literal string</strong>. Literal string can be quoted with double or single quotes.</p>
<pre><code>append(title,&quot;-123&quot;)
append(title,&#39;foo bar&#39;)</code></pre>
<p>In case of single quotes all the characters between quotes will be interpreted verbatim. When using double quotes, the values in quotes can be interpreted by some Fix functions.</p>
<pre><code>replace_all(title,&quot;My (.*) Pony&quot;,&quot;Our $1 Fish&quot;)   # Replace &#39;My Little Pony&#39; by &#39;Our Little Fish&#39;</code></pre>
<p>Some Fix functions accept zero or more <strong>options</strong> which need to be specified as a <em>name</em> <em>:</em> <em>value</em>:</p>
<pre><code>sort_field(tags, reverse:1)               # Sort the tags field in reverse order
lookup(&quot;title&quot;,&quot;dict.csv&quot;, sep_char:&#39;|&#39;,default:&#39;NONE&#39;)  # Lookup a title in a CSV file</code></pre>
<p>Unless specified otherwise (such as in <a href="#binds">Binds</a>), Fix function are executed in the <strong>order</strong> given by the Fix script:</p>
<pre><code>upcase(authors.*)
append(authors.*,&quot;abc&quot;)
replace_all(authors.*,&quot;a&quot;,&quot;AB&quot;)</code></pre>
<p>In the example above all transformations on the field <em>authors</em> will be executed in the order given. For example when the field authors contains this list:</p>
<pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="ot">---</span>
<span class="fu">authors:</span>
  <span class="kw">-</span> John
  <span class="kw">-</span> Mary
  <span class="kw">-</span> Dave</code></pre>
<p>The first fix will transform this list into:</p>
<pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="ot">---</span>
<span class="fu">authors:</span>
  <span class="kw">-</span> JOHN
  <span class="kw">-</span> MARY
  <span class="kw">-</span> DAVE</code></pre>
<p>The second fix will append “abc” to all authors</p>
<pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="ot">---</span>
<span class="fu">authors:</span>
  <span class="kw">-</span> JOHNabc
  <span class="kw">-</span> MARYabc
  <span class="kw">-</span> DAVEabc</code></pre>
<p>The third fix will replace all “a”-s by “AB”s</p>
<pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="ot">---</span>
<span class="fu">authors:</span>
  <span class="kw">-</span> JOHNABbc
  <span class="kw">-</span> MARYABbc
  <span class="kw">-</span> DAVEABbc</code></pre>
<p>In some cases the ordering of transformations of items in a list matters. For instance, you want to first do a sequence of transformation on all first items in a list, then a sequence of transformations on all second items in a list, etc. To change this ordering of Fix functions <a href="#binds">Binds</a> need to be used.</p>
<p>For a nearly complete list of functions currently available in Catmandu, take a look at the <a href="#fixes-cheat-sheet">Fixes Cheat Sheet</a>.</p>
</section>
<section id="selectors" class="level2">
<h2><span class="header-section-number">5.3</span> Selectors <a href="https://github.com/LibreCat/Catmandu/wiki/Selectors">✎</a></h2>
<p>With <strong>Fix selectors</strong> one can select which Catmandu items can end up in an output stream or not. Using a selector to throw away the records you are not interested in. For instance, to filter out all the records in a input use the <strong>reject()</strong> selector:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> MARC to YAML --fix <span class="st">&quot;reject()&quot;</span> <span class="kw">&lt;</span> data.mrc</code></pre>
<p>The command above will generate no output: every record is rejected. The opposite of reject() is the <strong>select()</strong> selector which can be used to select all the Catmandu items you want to keep in an output:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> MARC to YAML --fix <span class="st">&quot;select()&quot;</span> <span class="kw">&lt;</span> data.mrc</code></pre>
<p>The command above will return all the MARC items in the input file.</p>
<p>Selectors are of little use when used in isolation. Most of the time they are combined with <a href="#conditionals">Conditionals</a>. To select only the MARC records that have “Tsjechov” in the 100a field one can write:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> MARC to YAML --fix <span class="st">&quot;select marc_match(100a,&#39;.*Tsjechov.*&#39;) &quot;</span> <span class="kw">&lt;</span> data.mrc</code></pre>
<p>There are two alternative ways to combine selector with a conditional. Using the <em>guard</em> syntax, the conditional is written <em>after</em> the selector:</p>
<pre><code>reject exits(error.field)
reject all_match(publisher,&#39;xyz&#39;)
select any_match(years,2005)</code></pre>
<p>Using the <em>if/then/else</em> syntax the conditional is written explicitly:</p>
<pre><code>if exists(error.field)
   reject()
end

if all_match(publisher,&#39;xyz&#39;)
   reject()
end</code></pre>
</section>
<section id="conditionals" class="level2">
<h2><span class="header-section-number">5.4</span> Conditionals <a href="https://github.com/LibreCat/Catmandu/wiki/Conditionals">✎</a></h2>
<p>A <strong>Conditional</strong> is executed depending on a boolean condition that can be true or false. For instance, to skip a Catmandu item when the field <em>error</em> exists one would write the conditional <em>exists</em>:</p>
<pre><code>if exists(error)
  reject()
end</code></pre>
<p>A condition contains an <em>if</em> or <em>unless</em> statement a <strong>Conditional</strong> (Fix functions which can be true or false), a <em>body</em> of zero or more Fix functions and an optional <em>elsif</em> or <em>else</em> clause:</p>
<pre><code>if exists(error)
   # Write here all the Fix functions when the field &#39;error&#39; exists
end</code></pre>
<pre><code>unless exists(error)
  # Write here all the Fix functions when the field &#39;error&#39; doesn&#39;t exist
end</code></pre>
<pre><code>if exists(error)
   # If error exists then do this
elsif exists(warning)
   # If warning exists then do this
else
   # otherwise do this
end</code></pre>
<p>Catmandu also supports a limited number of boolean operators:</p>
<pre><code>exist(foo)  and add_field(ok,1)     # only execute add_field() when &#39;foo&#39; exists
exists(foo) or  add_field(error,1)  # only execute add_field() when &#39;foo&#39; doesn&#39;t exist</code></pre>
<p>Below follows some basic fix functions that are implemented in Catmandu. Check the manual pages of the individual Catmandu extensions for more elaborate Conditionals.</p>
<section id="all_equalpathvalue" class="level4 unnumbered">
<h4>all_equal(<em>path</em>,<em>value</em>)</h4>
<p>True, when the path exists and is exactly equal to a value. When the path points to a list, then all the list members need to be equal to the value. False otherwise.</p>
<pre><code>if all_equal(year,&quot;2018&quot;)
  set_field(published,&quot;future&quot;)
end

if all_equal(animals.*,&quot;cat&quot;)
  set_field(animal_types,&quot;feline&quot;)
end</code></pre>
</section>
<section id="any_equalpathvalue" class="level4 unnumbered">
<h4>any_equal(<em>path</em>,<em>value</em>)</h4>
<p>True, when the path exists and is exactly equal to a value. When the path points to a list, then at least one of the list members need to be equal to the value. False otherwise.</p>
<pre><code>if any_equal(year,&quot;2018&quot;)
  set_field(published,&quot;future&quot;)
end

if any_equal(animals.*,&quot;cat&quot;)
  set_field(animal_types,&quot;some feline&quot;)
end</code></pre>
</section>
<section id="all_matchpathregex" class="level4 unnumbered">
<h4>all_match(<em>path</em>,<em>regex</em>)</h4>
<p>True, when the path exists and the value matched the <em>regex</em> regular expression. When the path points to a list, then all the values have to match the regular expression. False otherwise.</p>
<pre><code>if all_match(year,&quot;^19.*$&quot;)
  set_field(period,&quot;20th century&quot;)
end

if all_match(publishers.*,&quot;Elsevier.*&quot;)
  set_field(is_elsevier,1)
end</code></pre>
</section>
<section id="any_matchpathregex" class="level4 unnumbered">
<h4>any_match(<em>path</em>,<em>regex</em>)</h4>
<p>True, when the path exists and the value matched the <em>regex</em> regular expression. When the path points to a list, then at least one of the values has to match the regular expression. False otherwise.</p>
<pre><code>if any_match(year,&quot;^19.*$&quot;)
  set_field(period,&quot;20th century&quot;)
end

if any_match(publishers.*,&quot;Elsevier.*&quot;)
  set_field(some_elsevier,1)
end</code></pre>
</section>
<section id="existspath" class="level4 unnumbered">
<h4>exists(<em>path</em>)</h4>
<p>True, when the path exists in the Catmandu item. False otherwise.</p>
<pre><code>if exists(my.deep.field)
end

if exists(my.list.0)
end</code></pre>
</section>
<section id="greater_thanpathnumber" class="level4 unnumbered">
<h4>greater_than(<em>path</em>,<em>number</em>)</h4>
<p>True, when the path exists and the value is greater than a number. When the path points to a list, then all the members need to be greater than the number. False otherwise.</p>
</section>
<section id="less_thanpathnumber" class="level4 unnumbered">
<h4>less_than(<em>path</em>,<em>number</em>)</h4>
<p>True, when the path exists and the value is less than a number. When the path points to a list, then all the members need to be less than the number. False otherwise.</p>
</section>
<section id="inpath1path2" class="level4 unnumbered">
<h4>in(<em>path1</em>,<em>path2</em>)</h4>
<p>True, when the values of the first path1 are contained in the values at the second path2. False otherwise.</p>
<p>For instance to check if two paths contain the same values type:</p>
<pre><code>if in(my.title,your.title)
  set_field(same,1)
end</code></pre>
<p>To check if a value in one path is contained in a list of an other path type:</p>
<pre><code>if in(my.author,your.authors.*)
   set_field(known_author,1)
end</code></pre>
</section>
<section id="is_truepath" class="level4 unnumbered">
<h4>is_true(<em>path</em>)</h4>
<p>True, if the value at path can be evaluated to a boolean true. False otherwise</p>
</section>
<section id="is_falsepath" class="level4 unnumbered">
<h4>is_false(<em>path</em>)</h4>
<p>True, if the value at path can be evaluated to a boolean false. False otherwise</p>
</section>
</section>
<section id="binds" class="level2">
<h2><span class="header-section-number">5.5</span> Binds <a href="https://github.com/LibreCat/Catmandu/wiki/Binds">✎</a></h2>
<p><strong>Binds</strong> change the execution context of a Fix script. In normal operation, all Fix functions are executed from the first to the last. For example given the YAML input:</p>
<pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="ot">---</span>
<span class="fu">colors:</span>
  <span class="kw">-</span> red
  <span class="kw">-</span> green
  <span class="kw">-</span> blue</code></pre>
<p>every Fix functions will be executed one by one on all the colors:</p>
<pre><code>upcase(colors.*)
append(colors.*,&quot; is a nice color&quot;)
copy_field(colors.*,result.$append)</code></pre>
<p>The first Fix <em>upcase</em> will uppercase all the colors, the second <em>append</em> will add &quot; is a nice color&quot; to all the colors, the last <em>copy_field</em> will copy all the colors to a new field.</p>
<p>But what should you do when you want the three Fix functions to operate on each color separately? First <em>upcase</em> on the first color, <em>append</em> on the first color, <em>copy_field</em> on the first color, then again <em>upcase</em> on the second color, <em>append</em> on the second color, etc.</p>
<p>For this type of operation a Bind is needed using the <em>do notation</em>:</p>
<pre><code>do list(path:colors.*, var:c)
  upcase(c)
  append(c,&quot; is a nice color&quot;)
  copy_field(c,result.$append)
end</code></pre>
<p>In the example above the <strong>list</strong> Bind was introduced. The context of the execution of the Bind body is changed. Instead of operating on one Catmandu item as a whole, the Fix functions are executed for each element in the list.</p>
<p>Each Bind changes the execution context in some way. For instance Fix functions could execute queries into database, or fetch data from the internet. These operations can fail when the database is down, or the website couldn’t be reached. What should happen in that case in a Fix script? Should the execution be stopped? Or, should there errors be ignored.</p>
<pre><code>my_fix1()
my_fix2()
download_from_internet() # &lt;--- this one failes
process_results()</code></pre>
<p>What should happen in the example above? Should the results be processed when the <em>download_from_internet</em> fails? Using the <strong>maybe</strong> Bind one can skip Fix functions that fail:</p>
<pre><code>do maybe()
  my_fix1()
  my_fix2()
  download_from_internet() 
  process_results() # &lt;--- this is skipped when download_from_internet fails
end</code></pre>
<p>Binds are also used when creating Fix executables. That are Fix scripts that can be run directly from the command line. In the example below we’ll write a Fix script that downloads data from an OAI-PMH repository and prints all the record identifiers:</p>
<pre><code>#!/usr/bin/env catmandu run
do importer(OAI,url: &quot;http://lib.ugent.be/oai&quot;) 
  retain(_id)
  add_to_exporter(.,YAML)
end</code></pre>
<p>If this script is stored on a file system as <em>myscript.fix</em> and made executable:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">chmod</span> 755 myscript.fix</code></pre>
<p>then you can run this script as any other Unix command:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">./myscript.fix</span></code></pre>
</section>
<section id="comments" class="level2">
<h2><span class="header-section-number">5.6</span> Comments <a href="https://github.com/LibreCat/Catmandu/wiki/Comments">✎</a></h2>
<p><em>Comments</em> can be added to the Fix scripts to enhance the readability of your transformations. All lines that start with a hash sign (#) are ignored by Catmandu:</p>
<pre><code># This is a comment
  # This is also a comment
add_field(foo,bar)  #This is a comment at the and of a line, add_field will be executed
# remove_field(foo) this line is a comment, remove_field(foo) will not be executed by the script</code></pre>
</section>
</section>
<section id="cheat-sheets" class="level1">
<h1><span class="header-section-number">6</span> Cheat sheets <a href="https://github.com/LibreCat/Catmandu/wiki/Cheat%20sheets">✎</a></h1>
<ul>
<li><a href="#-command-line-client-cheat-sheet|-">Command Line Cheat Sheet</a></li>
<li><a href="#fixes-cheat-sheet">Fixes Cheat Sheet</a></li>
<li><a href="#cookbook">Cookbook</a></li>
</ul>
<section id="command-line-client-cheat-sheet" class="level2">
<h2><span class="header-section-number">6.1</span> Command line client Cheat Sheet <a href="https://github.com/LibreCat/Catmandu/wiki/Command%20line%20client%20Cheat%20Sheet">✎</a></h2>
<p>This cheat sheet summarizes the <a href="#command-line-client">command line client</a> capabilities.</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> help
$ <span class="kw">catmandu</span> help convert</code></pre>
<section id="convert-1" class="level3">
<h3><span class="header-section-number">6.1.1</span> Convert</h3>
<p>Convert one data format to another optionally provide a Fix script to transform the data</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> convert MARC to JSON <span class="kw">&lt;</span> records.mrc
$ <span class="kw">catmandu</span> convert MARC to YAML <span class="kw">&lt;</span> records.mrc
$ <span class="kw">catmandu</span> convert MARC to JSON --pretty 1 <span class="kw">&lt;</span> records.mrc
$ <span class="kw">catmandu</span> convert MARC to JSON --fix <span class="st">&#39;marc_map(&quot;245&quot;,&quot;title&quot;);remove_field(&quot;record&quot;)&#39;</span> <span class="kw">&lt;</span> records.mrc
$ <span class="kw">catmandu</span> convert MARC to CSV --fix myfixes.fix <span class="kw">&lt;</span> records.mrc
$ <span class="kw">cat</span> myfixes.fix
<span class="kw">marc_map</span>(<span class="st">&quot;245&quot;</span>,<span class="st">&quot;title&quot;</span>)
<span class="kw">remove_field</span>(<span class="st">&quot;record&quot;</span>)
$ <span class="kw">catmandu</span> convert MARC to CSV --fix myfixes2.fix --var source=<span class="st">&quot;Springer&quot;</span> <span class="kw">&lt;</span> records.mrc
$ <span class="kw">cat</span> myfixes2.fix
<span class="kw">add_field</span>(<span class="st">&quot;source&quot;</span>,<span class="st">&quot;{{source}&quot;</span>)
<span class="kw">marc_map</span>(<span class="st">&quot;245&quot;</span>,<span class="st">&quot;title&quot;</span>)
<span class="kw">remove_field</span>(<span class="st">&quot;record&quot;</span>)
$ <span class="kw">catmandu</span> convert OAI --url http://biblio.ugent.be/oai --set allFtxt to JSON
$ <span class="kw">catmandu</span> convert OAI --url http://biblio.ugent.be/oai --set allFtxt to JSON --fix <span class="st">&#39;retain_field(&quot;title&quot;)&#39;</span>
$ <span class="kw">catmandu</span> convert SRU --base http://www.unicat.be/sru --query dna  
$ <span class="kw">catmandu</span> convert ArXiv --query <span class="st">&#39;all:electron&#39;</span>
$ <span class="kw">catmandu</span> convert PubMed --term <span class="st">&#39;hochstenbach&#39;</span>
$ <span class="kw">cat</span> test.tt
[<span class="kw">%-</span> FOREACH f IN record %]
[<span class="kw">%</span> _id %] [% f.shift %][% f.shift %][% f.shift %][% f.join(<span class="st">&quot;:&quot;</span>) <span class="kw">%</span>]
[<span class="kw">%-</span> END %]
$ <span class="kw">catmandu</span> convert MARC to Template --template <span class="kw">`pwd`</span>/test.tt <span class="kw">&lt;</span> records.mrc </code></pre>
</section>
<section id="importexport" class="level3">
<h3><span class="header-section-number">6.1.2</span> Import/Export</h3>
<p>Store data in a (noSQL) database and export it out again</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> import JSON to MongoDB --database_name mydb --bag data <span class="kw">&lt;</span> records.json
$ <span class="kw">catmandu</span> import MARC to MongoDB --database_name mydb --bag data <span class="kw">&lt;</span> records.mrc
$ <span class="kw">catmandu</span> import MARC to ElasticSearch --index_name mydb --bag data <span class="kw">&lt;</span> records.mrc
$ <span class="kw">catmandu</span> import MARC to ElasticSearch --index_name mydb --bag data --fix <span class="st">&#39;marc_map(&quot;245a&quot;,&quot;title&quot;)&#39;</span> <span class="kw">&lt;</span> records.mrc

$ <span class="kw">catmandu</span> export MongoDB --database_name mydb --bag data to JSON
$ <span class="kw">catmandu</span> export MongoDB --database_name mydb --bag data to JSON --fix <span class="st">&#39;retain_field(&quot;_id&quot;)&#39;</span>
$ <span class="kw">catmandu</span> export Solr --url http://localhost:8983/solr to JSON
$ <span class="kw">catmandu</span> export ElasticSearch --index_name mydb to JSON</code></pre>
</section>
<section id="copy" class="level3">
<h3><span class="header-section-number">6.1.3</span> Copy</h3>
<p>Copy data from one database to another</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> copy MongoDB --database_name items --bag book to ElasticSearch --index_name items --bag book</code></pre>
</section>
<section id="count" class="level3">
<h3><span class="header-section-number">6.1.4</span> Count</h3>
<p>Count the number of items in a store</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">catmandu</span> count ElasticSearch --index-name shop --bag products --query <span class="st">&#39;brand:Acme&#39;</span></code></pre>
</section>
<section id="delete" class="level3">
<h3><span class="header-section-number">6.1.5</span> Delete</h3>
<p>Delete data from a store</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="co"># delete items with matching _id</span>
$ <span class="kw">catmandu</span> delete ElasticSearch --index-name items --bag book --id 1234 --id 2345

<span class="co"># delete items matching the query</span>
$ <span class="kw">catmandu</span> delete ElasticSearch --index-name items --bag book --query <span class="st">&#39;title:&quot;My Rabbit&quot;&#39;</span>

<span class="co"># delete all items</span>
$ <span class="kw">catmandu</span> delete ElasticSearch --index-name items --bag book</code></pre>
</section>
<section id="configuration-2" class="level3">
<h3><span class="header-section-number">6.1.6</span> Configuration</h3>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">cat</span> catmandu.yml
<span class="kw">---</span>
<span class="kw">store</span>:
  <span class="kw">test1</span>:
   <span class="kw">package</span>: MongoDB
   <span class="kw">options</span>:
    <span class="kw">database_name</span>: mydb
  <span class="kw">test2</span>:
   <span class="kw">package</span>: ElasticSearch
   <span class="kw">options</span>:
    <span class="kw">index_name</span>: mydb
  <span class="kw">test3</span>:
   <span class="kw">package</span>: Solr
   <span class="kw">options</span>:
    <span class="kw">url</span>: http://localhost:8983/solr

$ <span class="kw">catmandu</span> import JSON to test1 <span class="kw">&lt;</span> records.json <span class="co"># Mongo</span>
$ <span class="kw">catmandu</span> import MARC to test2 <span class="kw">&lt;</span> records.mrc  <span class="co"># ElasticSearch</span>
$ <span class="kw">catmandu</span> import YAML to test3 <span class="kw">&lt;</span> records.yaml <span class="co"># Solr</span>
$ <span class="kw">catmandu</span> export test1 to JSON                <span class="co"># Mongo</span>
$ <span class="kw">catmandu</span> export test2 to JSON                <span class="co"># ElasticSearch</span>
$ <span class="kw">catmandy</span> export test3                        <span class="co"># Solr</span>
$ <span class="kw">cat</span> fixes.txt
<span class="kw">marc_map</span>(<span class="st">&quot;245a&quot;</span>,<span class="st">&quot;title&quot;</span>);
<span class="kw">marc_map</span>(<span class="st">&quot;100&quot;</span>,<span class="st">&quot;author.</span><span class="ot">$append</span><span class="st">&quot;</span>);
<span class="kw">join_field</span>(<span class="st">&quot;author&quot;</span>,<span class="st">&quot;;&quot;</span>);
<span class="kw">marc_map</span>(<span class="st">&quot;008_/10-13&quot;</span>,<span class="st">&quot;language&quot;</span>);
$ <span class="kw">catmandu</span> import MARC to test2 --fix fixes.txt</code></pre>
</section>
<section id="stream" class="level3">
<h3><span class="header-section-number">6.1.7</span> Stream</h3>
<pre class="(bash)"><code># Add a file to a FileStore
$ catmandu stream /tmp/myfile.txt to File::Simple --root t/data --bag 1234 --id myfile.txt

# Download a file from a FileStore
$ catmandu stream File::Simple --root t/data --bag 1234 --id myfile.txt to /tmp/output.txt
</code></pre>
</section>
</section>
<section id="fixes-cheat-sheet" class="level2">
<h2><span class="header-section-number">6.2</span> Fixes Cheat Sheet <a href="https://github.com/LibreCat/Catmandu/wiki/Fixes%20Cheat%20Sheet">✎</a></h2>
<p>This cheat sheet summarizes the <a href="#fix-language">fix language</a>. For more on the <code>marc_*</code> methods, see <a href="https://github.com/LibreCat/Catmandu-MARC/wiki/Mapping-rules">MARC mapping rules</a>.</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="co"># Fixes clean your data. As input you get a Perl HASH. Each fix function is a command</span>
<span class="co"># to transform the Perl HASH. Some fixes such as marc_map contain logic to transform</span>
<span class="co"># complex data structures such as MARC.</span>
<span class="kw">set_field</span>(<span class="st">&quot;my.name&quot;</span>,<span class="st">&quot;patrick&quot;</span>)             <span class="co"># { my =&gt; { name =&gt; &#39;Patrick&#39;} }</span>
<span class="kw">add_field</span>(<span class="st">&quot;my.name2&quot;</span>,<span class="st">&quot;nicolas&quot;</span>)
<span class="kw">move_field</span>(<span class="st">&quot;my.name&quot;</span>,<span class="st">&quot;your.name&quot;</span>)
<span class="kw">copy_field</span>(<span class="st">&quot;your.name&quot;</span>,<span class="st">&quot;your.name2&quot;</span>)
<span class="kw">remove_field</span>(<span class="st">&quot;your.name&quot;</span>)
<span class="co"># Replace in all the field names in &#39;foo&#39; all dots into underscores</span>
<span class="kw">rename</span>(foo,<span class="st">&quot;\.&quot;</span>,<span class="st">&quot;_&quot;</span>)

<span class="kw">set_array</span>(<span class="st">&quot;foo&quot;</span>)                           <span class="co"># Create an empty array foo =&gt; []</span>
<span class="kw">set_array</span>(<span class="st">&quot;foo&quot;</span>,<span class="st">&quot;a&quot;</span>,<span class="st">&quot;b&quot;</span>,<span class="st">&quot;c&quot;</span>)               <span class="co"># Create an array with three values foo =&gt; [&#39;a&#39;,&#39;b&#39;,&#39;c&#39;]</span>
<span class="kw">set_hash</span>(<span class="st">&quot;foo&quot;</span>)                            <span class="co"># Create an empty hash foo =&gt; {}</span>
<span class="kw">set_hash</span>(<span class="st">&quot;foo&quot;</span>,a: b,c: d)                  <span class="co"># Create an hash with two values foo =&gt; { a =&gt; &#39;b&#39; , c =&gt; &#39;d&#39; }</span>

<span class="kw">array</span>(<span class="st">&quot;foo&quot;</span>)                               <span class="co"># Create an array from a hash :</span>
                                           <span class="co"># foo =&gt; {&quot;name&quot;:&quot;value&quot;} =&gt; [ &quot;name&quot; , &quot;value&quot; ]</span>
<span class="kw">hash</span>(<span class="st">&quot;foo&quot;</span>)                                <span class="co"># Create a hash from an array</span>
                                           <span class="co"># foo =&gt; [ &quot;name&quot; , &quot;value&quot; ] =&gt; {&quot;name&quot;:&quot;value&quot;}</span>

<span class="kw">assoc</span>(fields, pairs.*.key, pairs.*.val)    <span class="co"># Associate two values as a hash key and value</span>
                                           <span class="co"># {pairs =&gt; [{key =&gt; &#39;year&#39;, val =&gt; 2009}, {key =&gt; &#39;subject&#39;, val =&gt; &#39;Perl&#39;}]}</span>
                                           <span class="co"># {fields =&gt; {subject =&gt; &#39;Perl&#39;, year =&gt; 2009}, pairs =&gt; [...]}</span>

<span class="kw">upcase</span>(<span class="st">&quot;title&quot;</span>)                            <span class="co"># marc -&gt; MARC</span>
<span class="kw">downcase</span>(<span class="st">&quot;title&quot;</span>)                          <span class="co"># MARC -&gt; marc</span>
<span class="kw">capitalize</span>(<span class="st">&quot;my.deeply.nested.field.0&quot;</span>)     <span class="co"># marc -&gt; Marc</span>
<span class="kw">trim</span>(<span class="st">&quot;field_with_spaces&quot;</span>)                  <span class="co"># &quot;  marc  &quot; -&gt; marc</span>
<span class="kw">substring</span>(<span class="st">&quot;title&quot;</span>,0,1)                     <span class="co"># marc -&gt; m</span>
<span class="kw">prepend</span>(<span class="st">&quot;title&quot;</span>,<span class="st">&quot;die &quot;</span>)                    <span class="co"># marc -&gt; die marc</span>
<span class="kw">append</span>(<span class="st">&quot;title&quot;</span>,<span class="st">&quot; must die&quot;</span>)                <span class="co"># marc -&gt; marc must die</span>

<span class="co"># {author =&gt; &quot;tom jones&quot;}  -&gt; {author =&gt; &quot;senoj mot&quot;}</span>
<span class="kw">reverse</span>(author)
 
<span class="co"># {numbers =&gt; [1,14,2]} -&gt; {numbers =&gt; [2,14,1]}</span>
<span class="kw">reverse</span>(numbers)

<span class="co"># replace the value with a formatted (sprintf-like) version</span>
<span class="co"># e.g. numbers: </span>
<span class="co">#         - 41</span>
<span class="co">#         - 15</span>
<span class="kw">format</span>(number,<span class="st">&quot;%-10.10d %-5.5d&quot;</span>) <span class="co"># numbers =&gt; &quot;0000000041 00015&quot;</span>
<span class="co"># e.g. hash:</span>
<span class="co">#        name: Albert</span>
<span class="kw">format</span>(name,<span class="st">&quot;%-10s: %s&quot;</span>) <span class="co"># hash: &quot;name      : Albert&quot;</span>

<span class="co"># date: &quot;2015-03-07&quot;</span>
<span class="kw">parse_text</span>(date, <span class="st">&#39;(\d\d\d\d)-(\d\d)-(\d\d)&#39;</span>)
<span class="co"># date: </span>
<span class="co">#    - 2015</span>
<span class="co">#    - 03</span>
<span class="co">#    - 07</span>

<span class="co">#  parses a text into an array or hash of values</span>
<span class="co"># date: &quot;2015-03-07&quot;</span>
<span class="kw">parse_text</span>(date, <span class="st">&#39;(\d\d\d\d)-(\d\d)-(\d\d)&#39;</span>)
<span class="co"># date: </span>
<span class="co">#    - 2015</span>
<span class="co">#    - 03</span>
<span class="co">#    - 07 </span>
 
<span class="co"># If you data record is:</span>
<span class="co">#   a: eeny</span>
<span class="co">#   b: meeny</span>
<span class="co">#   c: miny</span>
<span class="co">#   d: moe</span>
<span class="kw">paste</span>(my.string,a,b,c,d)                 <span class="co"># my.string: eeny meeny miny moe</span>
 
<span class="co"># Use a join character</span>
<span class="kw">paste</span>(my.string,a,b,c,d,join_char:<span class="st">&quot;, &quot;</span>)  <span class="co"># my.string: eeny, meeny, miny, moe</span>
 
<span class="co"># Paste literal strings with a tilde sign</span>
<span class="kw">paste</span>(my.string,~Hi,a,~how are you?)     <span class="co"># my.string: Hi eeny how are you?</span>

<span class="co"># date: &quot;2015-03-07&quot;</span>
<span class="kw">parse_text</span>(date, <span class="st">&#39;(?&lt;year&gt;\d\d\d\d)-(?&lt;month&gt;\d\d)-(?&lt;day&gt;\d\d)&#39;</span>)
<span class="co"># date:</span>
<span class="co">#   year: &quot;2015&quot;</span>
<span class="co">#   month: &quot;03&quot; </span>
<span class="co">#   day: &quot;07&quot;</span>
 
<span class="co"># date: &quot;abcd&quot;</span>
<span class="kw">parse_text</span>(date, <span class="st">&#39;(\d\d\d\d)-(\d\d)-(\d\d)&#39;</span>)
<span class="co"># date: &quot;abcd&quot;</span>

<span class="kw">lookup</span>(<span class="st">&quot;title&quot;</span>,<span class="st">&quot;dict.csv&quot;</span>, sep_char:<span class="st">&#39;|&#39;</span>)  <span class="co"># lookup &#39;marc&#39; in dict.csv and replace the value</span>
<span class="kw">lookup</span>(<span class="st">&quot;title&quot;</span>,<span class="st">&quot;dict.csv&quot;</span>, default:test)  <span class="co"># lookup &#39;marc&#39; in dict.csv and replace the value or set it to &#39;test&#39;</span>
<span class="kw">lookup</span>(<span class="st">&quot;title&quot;</span>,<span class="st">&quot;dict.csv&quot;</span>, delete:1)    <span class="co"># lookup &#39;marc&#39; in dict.csv and replace the value or delete nothing found</span>

<span class="kw">lookup_in_store</span>(<span class="st">&#39;title&#39;</span>, <span class="st">&#39;MongoDB&#39;</span>, database_name:lookups)  <span class="co"># lookup the (id)-value of title in &#39;lookups&#39; and</span>
                                           <span class="co"># replace it with the data found</span>
<span class="kw">lookup_in_store</span>(<span class="st">&#39;title&#39;</span>, <span class="st">&#39;MongoDB&#39;</span>, default:<span class="st">&#39;default value&#39;</span> , delete:1) 

<span class="co"># Query a Solr index with the query stored in the &#39;query&#39; field and overwrite it with all the results</span>
<span class="kw">search_in_store</span>(<span class="st">&#39;query&#39;</span>,<span class="st">&#39;Solr&#39;</span>,url:<span class="st">&quot;http://localhost:8983/solr&quot;</span>,limit:10)

<span class="co"># Replace the data in foo.bar with an external file or url</span>
<span class="kw">import</span>(foo.bar, JSON, file: <span class="st">&quot;http://foo.com/bar.json&quot;</span>, data_path: data.*)

<span class="kw">add_to_store</span>(<span class="st">&#39;authors.*&#39;</span>, <span class="st">&#39;MongoDB&#39;</span>, bag:authors, database_name:catalog)  <span class="co"># add matching values to a store as a side effect</span>

<span class="kw">add_to_exporter</span>(data,CSV,header:1,file:/tmp/data.csv) <span class="co"># send the &#39;data&#39; path to an alternative exporter</span>
<span class="kw">add_to_exporter</span>(.,CSV,header:1,file:/tmp/data.csv)    <span class="co"># send the complete record to an alternative exporter</span>

<span class="kw">count</span>(<span class="st">&quot;myarray&quot;</span>)                           <span class="co"># count number of elements in an array or hash</span>
<span class="kw">sum</span>(<span class="st">&quot;numbers&quot;</span>)                             <span class="co"># replace an array element with the sum of its values</span>
<span class="kw">sort_field</span>(<span class="st">&quot;tags&quot;</span>)                         <span class="co"># sort the values of an array</span>
<span class="kw">sort_field</span>(<span class="st">&quot;tags&quot;</span>, uniq:1)                 <span class="co"># sort the values plus keep unique values</span>
<span class="kw">sort_field</span>(<span class="st">&quot;tags&quot;</span>, reverse:1)              <span class="co"># revese sort</span>
<span class="kw">sort_field</span>(<span class="st">&quot;tags&quot;</span>, numeric:1)              <span class="co"># sort numerical values</span>
<span class="kw">uniq</span>(tags)                                 <span class="co"># strip duplicate values from an array</span>
<span class="kw">filter</span>(<span class="st">&quot;tags&quot;</span>,<span class="st">&quot;[Cc]at&quot;</span>)                    <span class="co"># filter array values tags = [&quot;Cats&quot;,&quot;Dogs&quot;] =&gt; [&quot;Cats&quot;]</span>
<span class="kw">flatten</span>(deep)                              <span class="co"># {deep =&gt; [1, [2, 3], 4, [5, [6, 7]]]} =&gt; {deep =&gt; [1, 2, 3, 4, 5, 6, 7]}</span>

<span class="kw">cmd</span>(<span class="st">&quot;java MyClass&quot;</span>)                        <span class="co"># Use an external program that can read JSON </span>
                                           <span class="co"># from stdin and write JSON to stdout</span>
<span class="kw">perlcode</span>(<span class="st">&quot;myscript.pl&quot;</span>)                    <span class="co"># Execute Perl code as fix function</span>
<span class="kw">sleep</span>(1,SECOND)                            <span class="co"># Do nothing for one second</span>

<span class="kw">split_field</span>(<span class="st">&quot;foo&quot;</span>,<span class="st">&quot;:&quot;</span>)                     <span class="co"># marc:must:die -&gt; [&#39;marc&#39;,&#39;must&#39;,&#39;die&#39;]</span>
<span class="kw">join_field</span>(<span class="st">&quot;foo&quot;</span>,<span class="st">&quot;:&quot;</span>)                      <span class="co"># [&#39;marc&#39;,&#39;must&#39;,&#39;die&#39;] -&gt; marc:must:die</span>
<span class="kw">retain</span>(<span class="st">&quot;id&quot;</span>,<span class="st">&quot;id2&quot;</span>,<span class="st">&quot;id3&quot;</span>)                   <span class="co"># delete any field except &#39;id&#39;, &#39;id2&#39;, &#39;id3&#39;</span>
<span class="kw">replace_all</span>(<span class="st">&quot;title&quot;</span>,<span class="st">&quot;a&quot;</span>,<span class="st">&quot;x&quot;</span>)               <span class="co"># marc -&gt; mxrc</span>

<span class="co"># Most functions can work also work on arrays. E.g.</span>
<span class="kw">replace_all</span>(<span class="st">&quot;author.*&quot;</span>,<span class="st">&quot;a&quot;</span>,<span class="st">&quot;x&quot;</span>)            <span class="co"># [ &#39;marc&#39;,&#39;jan&#39;] =&gt; [&#39;mxrc&#39;,&#39;jxn&#39;]</span>
<span class="co"># Use:</span>
<span class="co">#   authors.$end (last entry)</span>
<span class="co">#   authors.$start (first entry)</span>
<span class="co">#   authors.$append (last + 1)</span>
<span class="co">#   authors.$prepend (first - 1)</span>
<span class="co">#   authors.* (all authors)</span>
<span class="co">#   authors.2 (3rd author)</span>

<span class="fu">collapse()</span>                                 <span class="co"># collapse deep nested hash to a flat hash</span>
<span class="fu">expand()</span>                                   <span class="co"># expand flat hash to deep nested hash</span>
<span class="fu">clone()</span>                                    <span class="co"># clone the perl hash and work on the clone</span>
<span class="fu">reject()</span>                                   <span class="co"># Reject (skip) a record</span>
<span class="kw">reject</span> [condition]                         <span class="co"># Reject a record on some condition:</span>
                                           <span class="co">#   reject all_match(...)</span>
                                           <span class="co">#   reject any_match(...)</span>
                                           <span class="co">#   reject exists(...)</span>
<span class="fu">select()</span>                                   <span class="co"># Select a record</span>
<span class="kw">select</span> [<span class="kw">condition</span>]                         <span class="co"># Select only those records that match a condition (see reject)</span>

<span class="kw">to_json</span>(<span class="st">&#39;my.field&#39;</span>)                        <span class="co"># convert a value of a field to json</span>
<span class="kw">from_json</span>(<span class="st">&#39;my.field&#39;</span>)                      <span class="co"># replace the json field with the parsed value</span>

<span class="kw">export_to_string</span>(<span class="st">&#39;my.field&#39;</span>,CSV,sep_char:<span class="st">&quot;;&quot;</span>)   <span class="co"># convert the value of a field into CSV</span>
<span class="kw">import_from_string</span>(<span class="st">&#39;my.field&#39;</span>,CSV,sep_char:<span class="st">&quot;;&quot;</span>) <span class="co"># replace a CSV field with the parsed value</span>

<span class="kw">error</span>(<span class="st">&quot;eek!&quot;</span>)                              <span class="co"># abort the processing and say &quot;eek!&quot;</span>
<span class="fu">nothing()</span>                                  <span class="co"># do nothing (used in benchmarking)</span>

<span class="co"># Include fixes from another file</span>
<span class="kw">include</span>(<span class="st">&#39;/path/to/myfixes.txt&#39;</span>)

<span class="co"># Send debug messages to a logger</span>
<span class="kw">log</span>(<span class="st">&#39;test123&#39;</span>)
<span class="kw">log</span>(<span class="st">&#39;hello world&#39;</span> , level: <span class="st">&#39;DEBUG&#39;</span>)

<span class="co"># Boolean AND and OR, need a Condition + &#39;and&#39;/&#39;or&#39; + a Fix </span>
<span class="kw">exists</span>(foo) <span class="kw">and</span> log(<span class="st">&#39;foo exists&#39;</span> , level: INFO)
<span class="kw">exists</span>(foo) <span class="kw">or</span> log(<span class="st">&#39;foo doesnt exist&#39;</span> , level: INFO)
<span class="kw">valid</span>(<span class="st">&#39;&#39;</span>, JSONSchema, schema: <span class="st">&quot;my/schema.json&quot;</span>) <span class="kw">or</span> log(<span class="st">&#39;this record is wrong&#39;</span>, level: ERROR)

<span class="co"># &#39;3%A9&#39; =&gt; &#39;café&#39;</span>
<span class="kw">uri_decode</span>(place)
<span class="co"># &#39;café&#39; =&gt; &#39;3%A9&#39;</span>
<span class="kw">uri_encode</span>(place)

<span class="co"># Add a new field &#39;foo&#39; with a random value between 0 and 9</span>
<span class="kw">random</span>(foo, 10)

<span class="co"># Delete all the empty fields</span>
<span class="fu">vacuum()</span>

<span class="co"># Copy all 245 subfields into the my.title hash</span>
<span class="kw">marc_map</span>(<span class="st">&#39;245&#39;</span>,<span class="st">&#39;my.title&#39;</span>) 
<span class="co"># Copy the 245-$a$b$c subfields into the my.title hash in the order of the record</span>
<span class="kw">marc_map</span>(<span class="st">&#39;245abc&#39;</span>,<span class="st">&#39;my.title&#39;</span>) 
<span class="co"># Copy the 245-$c$b$a subfields into the my.title hash in the order of the mapping</span>
<span class="kw">marc_map</span>(<span class="st">&#39;245cba&#39;</span>,<span class="st">&#39;my.title&#39;</span> , pluck:1) 
<span class="co"># Copy the 100 subfields into the my.authors array</span>
<span class="kw">marc_map</span>(<span class="st">&#39;100&#39;</span>,<span class="st">&#39;my.authors.$append&#39;</span>) 
<span class="co"># Add the 710 subfields into the my.authors array</span>
<span class="kw">marc_map</span>(<span class="st">&#39;710&#39;</span>,<span class="st">&#39;my.authors.$append&#39;</span>)
<span class="co"># Copy the 600-$x subfields into the my.subjects array while packing each into a genre.text hash</span>
<span class="kw">marc_map</span>(<span class="st">&#39;600x&#39;</span>,<span class="st">&#39;my.subjects.$append.genre.text&#39;</span>)
<span class="co"># Copy the 008 characters 35-35 into the my.language hash</span>
<span class="kw">marc_map</span>(<span class="st">&#39;008_/35-35&#39;</span>,<span class="st">&#39;my.language&#39;</span>)
<span class="co"># Copy all the 600 fields into a my.stringy hash joining them by &#39;; &#39;</span>
<span class="kw">marc_map</span>(<span class="st">&#39;600&#39;</span>,<span class="st">&#39;my.stringy&#39;</span>, join:<span class="st">&#39;; &#39;</span>)
<span class="co"># When 024 field exists create the my.has024 hash with value &#39;found&#39;</span>
<span class="kw">marc_map</span>(<span class="st">&#39;024&#39;</span>,<span class="st">&#39;my.has024&#39;</span>, value:found)
<span class="co"># Do the same examples now with the marc fields in &#39;record2&#39;</span>
<span class="kw">marc_map</span>(<span class="st">&#39;245&#39;</span>,<span class="st">&#39;my.title&#39;</span>, record:record2)
<span class="co"># Remove the 900 fields</span>
<span class="kw">marc_remove</span>(<span class="st">&#39;900&#39;</span>)
<span class="co"># Add a marc field (in Catmandu::MARC 0.110)</span>
<span class="kw">marc_add</span>(<span class="st">&#39;999&#39;</span>, ind1, <span class="st">&#39; &#39;</span> , ind2, <span class="st">&#39;1&#39;</span> , a, <span class="st">&#39;test123&#39;</span>)
<span class="co"># Add a marc field populated with data from your record</span>
<span class="kw">marc_add</span>(<span class="st">&#39;245&#39;</span>, a , $.my.title.field, c , $.my.author.field)
<span class="co"># Set a marc value of one (sub)field to a new value</span>
<span class="kw">marc_set</span>(<span class="st">&#39;LDR/6&#39;</span>,<span class="st">&#39;p&#39;</span>)
<span class="kw">marc_set</span>(<span class="st">&#39;650p&#39;</span>,<span class="st">&#39;test&#39;</span>)
<span class="kw">marc_set</span>(<span class="st">&#39;100[3]a&#39;</span>,<span class="st">&#39;Farquhar family.&#39;</span>)

<span class="co"># Map all 650 subjects into an array </span>
<span class="kw">marc_map</span>(<span class="st">&#39;650&#39;</span>,<span class="st">&#39;subject&#39;</span>, join:<span class="st">&#39;###&#39;</span>) 
<span class="kw">split_field</span>(<span class="st">&#39;subject&#39;</span>,<span class="st">&#39;###&#39;</span>)

<span class="co"># uppercase the value of field &#39;foo&#39; if all members of &#39;oogly&#39; have the value &#39;doogly&#39;</span>
<span class="kw">if</span> <span class="kw">all_match</span>(<span class="st">&#39;oogly.*&#39;</span>, <span class="st">&#39;doogly&#39;</span>)
  <span class="kw">upcase</span>(<span class="st">&#39;foo&#39;</span>) <span class="co"># foo =&gt; &#39;BAR&#39;</span>
<span class="kw">else</span>
  <span class="kw">downcase</span>(<span class="st">&#39;foo&#39;</span>) <span class="co"># foo =&gt; &#39;bar&#39;</span>
<span class="kw">end</span>

<span class="co"># inverted</span>
<span class="kw">unless</span> all_match(<span class="st">&#39;oogly.*&#39;</span>, <span class="st">&#39;doogly&#39;</span>)
  <span class="kw">upcase</span>(<span class="st">&#39;foo&#39;</span>) <span class="co"># foo =&gt; &#39;BAR&#39;</span>
<span class="kw">end;</span>

<span class="co"># uppercase the value of field &#39;foo&#39; if field &#39;oogly&#39; has the value &#39;doogly&#39;</span>
<span class="kw">if</span> <span class="kw">any_match</span>(<span class="st">&#39;oogly&#39;</span>, <span class="st">&#39;doogly&#39;</span>)
  <span class="kw">upcase</span>(<span class="st">&#39;foo&#39;</span>) <span class="co"># foo =&gt; &#39;BAR&#39;</span>
<span class="kw">end</span>

<span class="co"># inverted</span>
<span class="kw">unless</span> any_match(<span class="st">&#39;oogly&#39;</span>, <span class="st">&#39;doogly&#39;</span>)
  <span class="kw">upcase</span>(<span class="st">&#39;foo&#39;</span>) <span class="co"># foo =&gt; &#39;BAR&#39;</span>
<span class="kw">end</span>

<span class="co"># uppercase the value of field &#39;foo&#39; if the field &#39;oogly&#39; exists</span>
<span class="kw">if</span> <span class="kw">exists</span>(<span class="st">&#39;oogly&#39;</span>)
  <span class="kw">upcase</span>(<span class="st">&#39;foo&#39;</span>) <span class="co"># foo =&gt; &#39;BAR&#39;</span>
<span class="kw">end</span>

<span class="co"># inverted</span>
<span class="kw">unless</span> exists(<span class="st">&#39;oogly&#39;</span>)
  <span class="kw">upcase</span>(<span class="st">&#39;foo&#39;</span>) <span class="co"># foo =&gt; &#39;bar&#39;</span>
<span class="kw">end</span>

<span class="co"># add a new field when the &#39;year&#39; field is equal to 2018</span>
<span class="kw">if</span> <span class="kw">all_equal</span>(<span class="st">&#39;year&#39;</span>,<span class="st">&#39;2018&#39;</span>)
 <span class="kw">add_field</span>(<span class="st">&#39;my.funny.title&#39;</span>,<span class="st">&#39;true&#39;</span>)
<span class="kw">end</span>

<span class="co"># add a new field when at least one of the &#39;year&#39;-s is equal to 2018</span>
<span class="kw">if</span> <span class="kw">any_equal</span>(<span class="st">&#39;years.*&#39;</span>,<span class="st">&#39;2018&#39;</span>)
 <span class="kw">add_field</span>(<span class="st">&#39;my.funny.title&#39;</span>,<span class="st">&#39;true&#39;</span>)
<span class="kw">end</span>

<span class="co"># compare things (needs Catmandu 0.92 or better)</span>
<span class="kw">if</span> <span class="kw">greater_than</span>(<span class="st">&#39;year&#39;</span>,2000)
  <span class="kw">add_field</span>(<span class="st">&#39;recent&#39;</span>,<span class="st">&#39;yes&#39;</span>)
<span class="kw">end</span>

<span class="kw">if</span> <span class="kw">less_than</span>(<span class="st">&#39;year&#39;</span>,1970)
  <span class="kw">add_field</span>(<span class="st">&#39;ancient&#39;</span>,<span class="st">&#39;yes&#39;</span>)
<span class="kw">end</span>

<span class="co"># execute fixes if one path is contained in another</span>
<span class="co"># foo =&gt; 1 , bar =&gt; [3,2,1]  =&gt; in(foo,bar) -&gt; true</span>
<span class="kw">if</span> <span class="kw">in(foo</span>,bar<span class="kw">)</span>
   <span class="kw">add_field</span>(test,ok)
<span class="kw">end</span>

<span class="co"># only execute fixes if all path values are the boolean true, 1 or &quot;true&quot;</span>
<span class="kw">if</span> <span class="kw">is_true</span>(data.*.has_error)
  <span class="kw">add_field</span>(error,yes)
<span class="kw">end</span>

<span class="co"># only execute fixes if all path values are the boolean true, 0 or &quot;false&quot;</span>
<span class="kw">if</span> <span class="kw">is_false</span>(data.*.has_error)
  <span class="kw">add_field</span>(error,no)
<span class="kw">end</span>

<span class="co"># only execute the fixes if the path contains an array</span>
<span class="kw">if</span> <span class="kw">is_array</span>(data)
  <span class="kw">upcase</span>(data.0)
<span class="kw">end</span>

<span class="co"># only execute the fixes if the path contains an object (an hash, nested field)</span>
<span class="kw">if</span> <span class="kw">is_object</span>(data)
  <span class="kw">add_field</span>(data.ok,yes)
<span class="kw">end</span>

<span class="co"># only execute the fixes if the path contains a number</span>
<span class="kw">if</span> <span class="kw">is_number</span>(data)
  <span class="kw">append</span>(data,<span class="st">&quot; : is a number&quot;</span>)
<span class="kw">end</span>

<span class="co"># only execute the fixes if the path contains a string</span>
<span class="kw">if</span> <span class="kw">is_string</span>(data)
  <span class="kw">append</span>(data,<span class="st">&quot; : is a string&quot;</span>)
<span class="kw">end</span>

<span class="co"># only execute the fixes if the path contains &#39;null&#39; values</span>
<span class="kw">if</span> <span class="kw">is_null</span>(data)
  <span class="kw">set_field</span>(data,<span class="st">&quot;I&#39;m empty!&quot;</span>)
<span class="kw">end</span>

<span class="co"># Evaluates true when a marc (sub)field matches a regular expression</span>
<span class="kw">if</span> <span class="kw">marc_match</span>(<span class="st">&#39;245&#39;</span>,<span class="st">&#39;My funny title&#39;</span>)
  <span class="kw">add_field</span>(<span class="st">&#39;funny.title&#39;</span>,<span class="st">&#39;yes&#39;</span>)
<span class="kw">end</span>
<span class="kw">if</span> <span class="kw">marc_match</span>(<span class="st">&#39;LDR/6&#39;</span>,<span class="st">&#39;c&#39;</span>)
  <span class="kw">marc_set</span>(<span class="st">&#39;LDR/6&#39;</span>,<span class="st">&#39;p&#39;</span>)
<span class="kw">end</span>

<span class="co"># Evaluates true when the JSON fragment is valid against a JSON Schema</span>
<span class="kw">if</span> <span class="kw">valid</span>(data,JSONSchema,schema:myschema.json)
   <span class="kw">...</span>
<span class="kw">end</span>

<span class="co">## Binds (needs Catmandu 0.92 or better)</span>

<span class="co"># The identity binder doesn&#39;t embody any computational strategy. It simply </span>
<span class="co"># applies the bound fix functions sequentially to its input without any </span>
<span class="co"># modification.</span>
<span class="kw">do</span> <span class="fu">identity()</span>
  <span class="kw">add_field</span>(foo,bar)
  <span class="kw">add_field</span>(foo2,bar2)
<span class="kw">end</span>

<span class="co"># Maybe, computes all the fix functions and ignores fixes once they throw errors</span>
<span class="co"># or return undef.</span>
<span class="kw">do</span> <span class="fu">maybe()</span>
  <span class="fu">foo()</span>
  <span class="fu">return_undef()</span> <span class="co"># rest will be ignored</span>
  <span class="fu">bar()</span>
<span class="kw">end</span>

<span class="co"># List over all items in demo and add a foo =&gt; bar field</span>
<span class="co"># { demo =&gt; [{},{},{}] } =&gt; { demo =&gt; [{foo=&gt;bar},{foo=&gt;bar},{foo=&gt;bar}]}</span>
<span class="kw">do</span> <span class="kw">list</span>(path: demo)
  <span class="kw">add_field</span>(foo,bar)
<span class="kw">end</span>

<span class="co"># Print statistical information on the processing speed of fixes to the standaard error.</span>
<span class="kw">do</span> <span class="kw">benchmark</span>(output:/dev/stderr)
  <span class="fu">foo()</span>
<span class="kw">end</span>

<span class="co"># Find all ISBN in a stream</span>
<span class="kw">do</span> <span class="kw">hashmap</span>(exporter: JSON, join:<span class="st">&#39;,&#39;</span>)
  <span class="co"># Need an identity binder to group all operations that calculate key_value pairs</span>
  <span class="kw">do</span> <span class="fu">identity()</span>
   <span class="kw">copy_field</span>(isbn,key)
   <span class="kw">copy_field</span>(_id,value)
  <span class="kw">end</span>
<span class="kw">end</span>

<span class="co"># Count the number of ISBN occurrences in a stream</span>
<span class="kw">do</span> <span class="kw">hashmap</span>(count: 1)
  <span class="kw">copy_field</span>(isbn,key)
<span class="kw">end</span>

<span class="co"># Filter out an array (needs Catmandu 0.9302 or better)</span>
<span class="co">#    data:</span>
<span class="co">#       - name: patrick</span>
<span class="co">#       - name: nicolas</span>
<span class="co"># to:</span>
<span class="co">#    data:</span>
<span class="co">#       - name: patrick</span>
<span class="kw">do</span> <span class="kw">with</span>(path:data)
  <span class="kw">reject</span> all_match(name,nicolas)
  <span class="co"># Or:</span>
  <span class="co"># if all_match(name,nicolas)</span>
  <span class="co">#  reject()</span>
  <span class="co"># end</span>
<span class="kw">end</span>

<span class="co">#  run fixes that should run within a time limit</span>
<span class="kw">do</span> <span class="kw">timeout</span>(time =<span class="kw">&gt;</span> 5, units =<span class="kw">&gt;</span> seconds)
  <span class="kw">...</span>
<span class="kw">end</span>

<span class="co"># a binder that computes Fix-es for every element in record</span>
<span class="kw">do</span> <span class="fu">visitor()</span>
   <span class="co"># upcase all the &#39;name&#39; fields in the record</span>
   <span class="kw">if</span> <span class="kw">all_match</span>(key,name)
     <span class="kw">upcase</span>(scalar)
   <span class="kw">end</span>
<span class="kw">end</span>

<span class="co"># a binder runs fixes on records from an importer</span>
<span class="kw">do</span> <span class="kw">importer</span>(OAI,url: <span class="st">&quot;http://lib.ugent.be/oai&quot;</span>) 
  <span class="kw">retain</span>(_id)
  <span class="kw">add_to_exporter</span>(.,YAML)
<span class="kw">end</span></code></pre>
</section>
<section id="example-fix-script" class="level2">
<h2><span class="header-section-number">6.3</span> Example Fix Script <a href="https://github.com/LibreCat/Catmandu/wiki/Example%20Fix%20Script">✎</a></h2>
<p>Here is an example Fix script taken from a production system at Ghent University Library that can be used for inspiration. This script is used to feed data from a MongoDB store of MARC records to a <a href="http://projectblacklight.org/">Black Light</a> Solr installation.</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="co">#-</span>
<span class="co">#- LLUDSS - Data cleaning fixes. Using MARC records as input</span>
<span class="co">#-</span>
<span class="co">#- 2013 Patrick.Hochstenbach@UGent.be</span>
<span class="co">#-</span>

<span class="kw">copy_field</span>(<span class="st">&#39;merge.source&#39;</span>,<span class="st">&#39;source&#39;</span>)
<span class="kw">copy_field</span>(<span class="st">&#39;merge.id&#39;</span>,<span class="st">&#39;id&#39;</span>)
<span class="kw">set_field</span>(<span class="st">&#39;is_deleted&#39;</span>,<span class="st">&#39;false&#39;</span>)

<span class="kw">set_field</span>(<span class="st">&#39;is_hidden&#39;</span>,<span class="st">&#39;false&#39;</span>)
<span class="kw">copy_field</span>(<span class="st">&#39;merge.hidden&#39;</span>,<span class="st">&#39;is_hidden&#39;</span>)

<span class="kw">if</span> <span class="kw">exists</span>(<span class="st">&#39;merge.related_desc&#39;</span>)
    <span class="kw">copy_field</span>(<span class="st">&#39;merge.related_desc&#39;</span>,<span class="st">&#39;json.merge_related_desc&#39;</span>)
<span class="kw">end</span>

<span class="kw">if</span> <span class="kw">exists</span>(<span class="st">&#39;merge.deleted&#39;</span>)
    <span class="kw">set_field</span>(<span class="st">&#39;is_deleted&#39;</span>,<span class="st">&#39;true&#39;</span>)
<span class="kw">else</span>
    <span class="co">#- Document Type</span>
    <span class="kw">unless</span> exists(<span class="st">&#39;type&#39;</span>)
        <span class="kw">marc_map</span>(<span class="st">&#39;920a&#39;</span>,<span class="st">&#39;type&#39;</span>)
        <span class="kw">lookup</span>(<span class="st">&quot;type&quot;</span>,<span class="st">&quot;/opt/lludss-import/etc/material_types.csv&quot;</span>, default:<span class="st">&quot;other&quot;</span>)
    <span class="kw">end</span>

    <span class="co">#- ISBN/ISSN</span>
    <span class="kw">marc_map</span>(<span class="st">&#39;020a&#39;</span>,<span class="st">&#39;isbn.$append&#39;</span>, join:<span class="st">&#39;==&#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;022a&#39;</span>,<span class="st">&#39;issn.$append&#39;</span>, join:<span class="st">&#39;==&#39;</span>)
    <span class="kw">join_field</span>(<span class="st">&#39;isbn&#39;</span>,<span class="st">&#39;==&#39;</span>)
    <span class="kw">split_field</span>(<span class="st">&#39;isbn&#39;</span>,<span class="st">&#39;==&#39;</span>)
    <span class="kw">join_field</span>(<span class="st">&#39;issn&#39;</span>,<span class="st">&#39;==&#39;</span>)
    <span class="kw">split_field</span>(<span class="st">&#39;issn&#39;</span>,<span class="st">&#39;==&#39;</span>)
    <span class="kw">replace_all</span>(<span class="st">&#39;isbn.*&#39;</span>,<span class="st">&#39;^([0-9xX-]+).*$&#39;</span>,<span class="st">&#39;$1&#39;</span>)
    <span class="kw">replace_all</span>(<span class="st">&#39;issn.*&#39;</span>,<span class="st">&#39;^([0-9xX-]+).*&#39;</span>,<span class="st">&#39;$1&#39;</span>)

    <span class="co">#- Title</span>
    <span class="kw">marc_map</span>(<span class="st">&#39;245ab&#39;</span>,<span class="st">&#39;title&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">replace_all</span>(<span class="st">&#39;title&#39;</span>,<span class="st">&#39;\[(.*)\]&#39;</span>,<span class="st">&#39;$1&#39;</span>)
    <span class="kw">copy_field</span>(<span class="st">&#39;title&#39;</span>,<span class="st">&#39;title_sort&#39;</span>)
    <span class="kw">replace_all</span>(<span class="st">&#39;title_sort&#39;</span>,<span class="st">&#39;\W+&#39;</span>,<span class="st">&#39;&#39;</span>)
    <span class="kw">substring</span>(<span class="st">&#39;title_sort&#39;</span>,0,50)
    <span class="kw">downcase</span>(<span class="st">&#39;title_sort&#39;</span>)
    <span class="kw">copy_field</span>(<span class="st">&#39;title&#39;</span>,<span class="st">&#39;json.title&#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;246&#39;</span>,<span class="st">&#39;json.title_remainder&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;245a&#39;</span>,<span class="st">&#39;title_short&#39;</span>)

    <span class="co">#- Author</span>
    <span class="kw">marc_map</span>(<span class="st">&#39;100ab&#39;</span>,<span class="st">&#39;author.$append&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;700ab&#39;</span>,<span class="st">&#39;author.$append&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">unless</span> all_match(<span class="st">&#39;type&#39;</span>,<span class="st">&#39;phd|master|bachelor&#39;</span>)
        <span class="kw">marc_map</span>(<span class="st">&#39;720ab&#39;</span>,<span class="st">&#39;author.$append&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">end</span>
    <span class="fu">author_names()</span>
    <span class="kw">copy_field</span>(<span class="st">&#39;author&#39;</span>,<span class="st">&#39;json.author&#39;</span>)

    <span class="co">#- Imprint</span>
    <span class="kw">marc_map</span>(<span class="st">&#39;008_/7-10&#39;</span>,<span class="st">&#39;year&#39;</span>)
    <span class="kw">if</span> <span class="kw">all_match</span>(<span class="st">&#39;year&#39;</span>,<span class="st">&#39;[u^?-]{4}&#39;</span>)
       <span class="kw">remove_field</span>(<span class="st">&#39;year&#39;</span>)
    <span class="kw">end</span>
    <span class="kw">replace_all</span>(<span class="st">&#39;year&#39;</span>,<span class="st">&#39;\D&#39;</span>,<span class="st">&#39;0&#39;</span>)

    <span class="kw">if</span> <span class="kw">greater_than</span>(<span class="st">&#39;2018&#39;</span>,<span class="st">&#39;year&#39;</span>)
        <span class="kw">remove_field</span>(<span class="st">&#39;year&#39;</span>)
    <span class="kw">end</span>

    <span class="kw">if</span> <span class="kw">marc_match</span>(<span class="st">&#39;008_/6-6&#39;</span>,<span class="st">&#39;b&#39;</span>)
        <span class="kw">prepend</span>(<span class="st">&#39;year&#39;</span>,<span class="st">&#39;-&#39;</span>)
    <span class="kw">end</span>

    <span class="co">#- Edition</span>
    <span class="kw">marc_map</span>(<span class="st">&#39;250a&#39;</span>,<span class="st">&#39;json.edition&#39;</span>)

    <span class="co">#- Description</span>
    <span class="kw">marc_map</span>(<span class="st">&#39;300a&#39;</span>,<span class="st">&#39;json.desc_extend&#39;</span>)

    <span class="co">#- Summary</span>
    <span class="kw">marc_map</span>(<span class="st">&#39;505a&#39;</span>,<span class="st">&#39;json.summary.$append&#39;</span>, join:<span class="st">&quot;\n&quot;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;520a&#39;</span>,<span class="st">&#39;json.summary.$append&#39;</span>, join:<span class="st">&quot;\n&quot;</span>)

    <span class="co">#- Als we een dissertation hebben dan is 502 de summary met 720 als promotor.</span>
    <span class="co">#- Dit is dan ook automatisch een UGent publiaction</span>
    <span class="kw">if</span> <span class="kw">all_match</span>(<span class="st">&#39;type&#39;</span>,<span class="st">&#39;phd|master&#39;</span>)
        <span class="kw">marc_map</span>(<span class="st">&#39;502a&#39;</span>,<span class="st">&#39;summary.$append&#39;</span>)

        <span class="kw">if</span> <span class="kw">exists</span>(<span class="st">&#39;summary&#39;</span>);
            <span class="kw">join_field</span>(<span class="st">&#39;summary&#39;</span>,<span class="st">&#39;&#39;</span>)
            <span class="kw">move_field</span>(<span class="st">&#39;summary&#39;</span>,<span class="st">&#39;json.summary.$append&#39;</span>)
        <span class="kw">end</span>

        <span class="kw">add_field</span>(<span class="st">&#39;only.$append&#39;</span>,<span class="st">&#39;ugent&#39;</span>)
    <span class="kw">end</span>

    <span class="kw">unless</span> exists(<span class="st">&#39;json.summary&#39;</span>)
        <span class="kw">weave_by_id</span>(<span class="st">&#39;summary&#39;</span>)
        <span class="kw">if</span> <span class="kw">exists</span>(<span class="st">&#39;_weave.summary.data.summary&#39;</span>)
            <span class="kw">copy_field</span>(<span class="st">&#39;_weave.summary.data.summary&#39;</span>,<span class="st">&#39;json.summary.$append&#39;</span>)
        <span class="kw">end</span>
        <span class="kw">remove_field</span>(<span class="st">&#39;_weave&#39;</span>)
    <span class="kw">end</span>

    <span class="co">#- Boost</span>
    <span class="kw">unless</span> exists(<span class="st">&#39;_boost&#39;</span>)
        <span class="kw">weave_by_id</span>(<span class="st">&#39;boost&#39;</span>)
        <span class="kw">if</span> <span class="kw">exists</span>(<span class="st">&#39;_weave.boost.data.boost&#39;</span>)
            <span class="kw">copy_field</span>(<span class="st">&#39;_weave.boost.data.boost&#39;</span>,<span class="st">&#39;_boost&#39;</span>)
        <span class="kw">end</span>
        <span class="kw">remove_field</span>(<span class="st">&#39;_weave&#39;</span>)
    <span class="kw">end</span>

    <span class="co">#- Language</span>
    <span class="kw">marc_map</span>(<span class="st">&#39;008_/35-37&#39;</span>,<span class="st">&#39;lang&#39;</span>)
    <span class="kw">if</span> <span class="kw">all_match</span>(<span class="st">&#39;lang&#39;</span>,<span class="st">&#39;\W+&#39;</span>)
        <span class="kw">set_field</span>(<span class="st">&#39;lang&#39;</span>,<span class="st">&#39;und&#39;</span>)
    <span class="kw">end</span>

    <span class="co">#- Subject</span>
    <span class="kw">marc_map</span>(<span class="st">&#39;6**^0123456789&#39;</span>,<span class="st">&#39;subject.$append&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">replace_all</span>(<span class="st">&#39;subject.*&#39;</span>,<span class="st">&#39;\.$&#39;</span>,<span class="st">&#39;&#39;</span>)
    <span class="kw">sort_field</span>(<span class="st">&#39;subject&#39;</span>, uniq:1)
    <span class="kw">copy_field</span>(<span class="st">&#39;subject&#39;</span>,<span class="st">&#39;json.subject&#39;</span>)

    <span class="co">#- Library, Faculty, Location</span>
    <span class="kw">marc_map</span>(<span class="st">&#39;852c&#39;</span>,<span class="st">&#39;library.$append&#39;</span>)
    <span class="kw">sort_field</span>(<span class="st">&#39;library&#39;</span>, uniq:1)
    <span class="kw">marc_map</span>(<span class="st">&#39;852x&#39;</span>,<span class="st">&#39;faculty.$append&#39;</span>)
    <span class="kw">sort_field</span>(<span class="st">&#39;faculty&#39;</span>, uniq:1)
    <span class="kw">marc_map</span>(<span class="st">&#39;852j&#39;</span>,<span class="st">&#39;location.$append&#39;</span>)
    <span class="kw">sort_field</span>(<span class="st">&#39;location&#39;</span>, uniq:1)

     <span class="co">#- Host publication</span>
    <span class="fu">host_publication()</span>
    <span class="kw">move_field</span>(<span class="st">&#39;host_publication&#39;</span>,<span class="st">&#39;json.host_publication.$append&#39;</span>)

    <span class="co">#- Holding</span>
    <span class="kw">if</span> <span class="kw">exists</span>(<span class="st">&#39;p_holding&#39;</span>)
        <span class="kw">copy_field</span>(<span class="st">&#39;p_holding&#39;</span>,<span class="st">&#39;year&#39;</span>)
        <span class="kw">replace_all</span>(<span class="st">&#39;year&#39;</span>,<span class="st">&#39; .*&#39;</span>,<span class="st">&#39;&#39;</span>)
        <span class="kw">move_field</span>(<span class="st">&#39;p_holding&#39;</span>,<span class="st">&#39;json.p_holding&#39;</span>)
        <span class="kw">move_field</span>(<span class="st">&#39;p_holding_txt&#39;</span>,<span class="st">&#39;json.host_publication.$append&#39;</span>)
    <span class="kw">end</span>
    <span class="kw">if</span> <span class="kw">exists</span>(<span class="st">&#39;e_holding&#39;</span>)
        <span class="kw">copy_field</span>(<span class="st">&#39;e_holding&#39;</span>,<span class="st">&#39;year&#39;</span>)
        <span class="kw">replace_all</span>(<span class="st">&#39;year&#39;</span>,<span class="st">&#39; .*&#39;</span>,<span class="st">&#39;&#39;</span>)
        <span class="kw">move_field</span>(<span class="st">&#39;e_holding&#39;</span>,<span class="st">&#39;json.e_holding&#39;</span>)
        <span class="kw">move_field</span>(<span class="st">&#39;e_holding_txt&#39;</span>,<span class="st">&#39;json.host_publication.$append&#39;</span>)
    <span class="kw">end</span>

    <span class="kw">join_field</span>(<span class="st">&#39;json.host_publication&#39;</span>,<span class="st">&#39;&lt;br&gt;&#39;</span>);

    <span class="co">#- Year cleanup</span>
    <span class="kw">replace_all</span>(<span class="st">&#39;year&#39;</span>,<span class="st">&#39;^(?&lt;=-)?0+&#39;</span>,<span class="st">&#39;&#39;</span>)
    <span class="kw">unless</span> all_match(<span class="st">&#39;year&#39;</span>,<span class="st">&#39;^-?([0-9]|[123456789][0-9]+)$&#39;</span>)
        <span class="kw">remove_field</span>(<span class="st">&#39;year&#39;</span>)
    <span class="kw">end</span>

    <span class="co">#- Wikipedia</span>
    <span class="kw">weave_by_id</span>(<span class="st">&#39;wikipedia&#39;</span>)
    <span class="kw">copy_field</span>(<span class="st">&#39;_weave.wikipedia.data.wikipedia_url&#39;</span>,<span class="st">&#39;json.wikipedia_url&#39;</span>)
    <span class="kw">remove_field</span>(<span class="st">&#39;_weave&#39;</span>)

    <span class="co">#- Cover Image</span>
    <span class="kw">if</span> <span class="kw">all_match</span>(<span class="st">&#39;merge.source&#39;</span>,<span class="st">&#39;rug01|pug01|ebk01&#39;</span>)
        <span class="kw">weave_by_id</span>(<span class="st">&#39;cover&#39;</span>)
        <span class="kw">copy_field</span>(<span class="st">&#39;_weave.cover.data.cover_remote&#39;</span>,<span class="st">&#39;json.cover_remote&#39;</span>)
        <span class="kw">remove_field</span>(<span class="st">&#39;_weave&#39;</span>)
    <span class="kw">end</span>

    <span class="co">#- Cover card-catalog</span>
    <span class="kw">if</span>  <span class="kw">exists</span>(cid)
        <span class="kw">add_field</span>(<span class="st">&#39;json.cover_remote.$append&#39;</span>,<span class="st">&#39;http://search.ugent.be/meercat/x/stream?source=rug02&amp;id=&#39;</span>)
        <span class="kw">move_field</span>(<span class="st">&#39;cid&#39;</span>,<span class="st">&#39;json.cover_remote.$append&#39;</span>)
        <span class="kw">join_field</span>(<span class="st">&#39;json.cover_remote&#39;</span>,<span class="st">&#39;&#39;</span>)
    <span class="kw">end</span>

    <span class="co">#- Fulltext</span>
    <span class="fu">fulltext()</span>
    <span class="kw">move_field</span>(<span class="st">&#39;fulltext&#39;</span>,<span class="st">&#39;json.fulltext&#39;</span>)

    <span class="co">#- Remove record without items or fulltext</span>
    <span class="kw">unless</span> exists(<span class="st">&#39;items&#39;</span>)
        <span class="kw">unless</span> exists(<span class="st">&#39;json.fulltext&#39;</span>)
            <span class="kw">set_field</span>(<span class="st">&#39;is_deleted&#39;</span>,<span class="st">&#39;true&#39;</span>)
        <span class="kw">end</span>
    <span class="kw">end</span>

    <span class="co">#- CATEGORY</span>
    <span class="kw">if</span> <span class="kw">exists</span>(<span class="st">&#39;json.fulltext&#39;</span>)
        <span class="kw">add_field</span>(<span class="st">&#39;only.$append&#39;</span>,<span class="st">&#39;online&#39;</span>)
    <span class="kw">end</span>
    <span class="kw">if</span> <span class="kw">exists</span>(<span class="st">&#39;items&#39;</span>)
        <span class="kw">add_field</span>(<span class="st">&#39;only.$append&#39;</span>,<span class="st">&#39;print&#39;</span>)
    <span class="kw">end</span>

    <span class="kw">if</span> <span class="kw">all_match</span>(<span class="st">&#39;merge.source&#39;</span>,<span class="st">&#39;pug01&#39;</span>)
       <span class="kw">add_field</span>(<span class="st">&#39;only.$append&#39;</span>,<span class="st">&#39;ugent&#39;</span>)
    <span class="kw">end</span>

    <span class="kw">sort_field</span>(<span class="st">&quot;only&quot;</span>, uniq:1, reverse:0)

    <span class="co">#- ALL Field</span>
    <span class="fu">all()</span>

    <span class="co">#- Identifier indexes rug01, ser01, ...</span>
    <span class="fu">ids()</span>

    <span class="co">#- Set</span>
    <span class="kw">marc_map</span>(<span class="st">&#39;005&#39;</span>,<span class="st">&#39;updated_at&#39;</span>)
    <span class="co">#- Warning: Aleph doesn&#39;t do zulu-time...</span>
    <span class="kw">datetime_format</span>(<span class="st">&#39;updated_at&#39;</span>, time_zone:<span class="st">&#39;Europe/Brussels&#39;</span>, set_time_zone:<span class="st">&#39;UTC&#39;</span>, source_pattern: <span class="st">&#39;%Y%m%d%H%M%S.%N&#39;</span>, destination_pattern:<span class="st">&#39;%Y-%m-%dT%H:%M:%SZ&#39;</span>, delete:1)
    <span class="kw">add_field</span>(<span class="st">&#39;is_oai&#39;</span>,<span class="st">&#39;false&#39;</span>)
    <span class="kw">if</span> <span class="kw">exists</span>(<span class="st">&#39;updated_at&#39;</span>)
        <span class="kw">add_field</span>(<span class="st">&#39;set.$append&#39;</span>,<span class="st">&#39;all&#39;</span>)
        <span class="kw">set_field</span>(<span class="st">&#39;is_oai&#39;</span>,<span class="st">&#39;true&#39;</span>)
    <span class="kw">end</span>
    <span class="kw">sort_field</span>(<span class="st">&#39;set&#39;</span>, unique:1)

    <span class="co">#- MARC Display</span>
    <span class="kw">marc_map</span>(<span class="st">&#39;245&#39;</span>,<span class="st">&#39;marc_display.$append.title&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;246&#39;</span>,<span class="st">&#39;marc_display.$append.other-title&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;765&#39;</span>,<span class="st">&#39;marc_display.$append.orig-title&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;210&#39;</span>,<span class="st">&#39;marc_display.$append.abbrev-title&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;240&#39;</span>,<span class="st">&#39;marc_display.$append.other-title&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;020&#39;</span>,<span class="st">&#39;marc_display.$append.isbn&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;022&#39;</span>,<span class="st">&#39;marc_display.$append.issn&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;028&#39;</span>,<span class="st">&#39;marc_display.$append.publisher-no&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;048&#39;</span>,<span class="st">&#39;marc_display.$append.voices-code&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;100&#39;</span>,<span class="st">&#39;marc_display.$append.author&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;110&#39;</span>,<span class="st">&#39;marc_display.$append.corp-author&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;700&#39;</span>,<span class="st">&#39;marc_display.$append.author&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;720&#39;</span>,<span class="st">&#39;marc_display.$append.other-name&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;111&#39;</span>,<span class="st">&#39;marc_display.$append.conference&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;130&#39;</span>,<span class="st">&#39;marc_display.$append.other-title&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;250&#39;</span>,<span class="st">&#39;marc_display.$append.edition&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;255&#39;</span>,<span class="st">&#39;marc_display.$append.scale&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;256&#39;</span>,<span class="st">&#39;marc_display.$append.edition&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;260&#39;</span>,<span class="st">&#39;marc_display.$append.publisher&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;261&#39;</span>,<span class="st">&#39;marc_display.$append.publisher&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;263&#39;</span>,<span class="st">&#39;marc_display.$append.publisher&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;300&#39;</span>,<span class="st">&#39;marc_display.$append.description&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;310&#39;</span>,<span class="st">&#39;marc_display.$append.frequency&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;321&#39;</span>,<span class="st">&#39;marc_display.$append.prior-freq&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;340&#39;</span>,<span class="st">&#39;marc_display.$append.description&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;362&#39;</span>,<span class="st">&#39;marc_display.$append.pub-history&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;400&#39;</span>,<span class="st">&#39;marc_display.$append.series&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;410&#39;</span>,<span class="st">&#39;marc_display.$append.series&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;440&#39;</span>,<span class="st">&#39;marc_display.$append.series&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;490&#39;</span>,<span class="st">&#39;marc_display.$append.series&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;500&#39;</span>,<span class="st">&#39;marc_display.$append.note&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;501&#39;</span>,<span class="st">&#39;marc_display.$append.note&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;502&#39;</span>,<span class="st">&#39;marc_display.$append.thesis&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;504&#39;</span>,<span class="st">&#39;marc_display.$append.bibliography&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;505&#39;</span>,<span class="st">&#39;marc_display.$append.content&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;508&#39;</span>,<span class="st">&#39;marc_display.$append.credits&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;510&#39;</span>,<span class="st">&#39;marc_display.$append.note&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;511&#39;</span>,<span class="st">&#39;marc_display.$append.performers&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;515&#39;</span>,<span class="st">&#39;marc_display.$append.note&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;518&#39;</span>,<span class="st">&#39;marc_display.$append.note&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;520&#39;</span>,<span class="st">&#39;marc_display.$append.summary&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;521&#39;</span>,<span class="st">&#39;marc_display.$append.note&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;525&#39;</span>,<span class="st">&#39;marc_display.$append.note&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;530&#39;</span>,<span class="st">&#39;marc_display.$append.note&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;533&#39;</span>,<span class="st">&#39;marc_display.$append.note&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;534&#39;</span>,<span class="st">&#39;marc_display.$append.note&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;540&#39;</span>,<span class="st">&#39;marc_display.$append.note&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;541&#39;</span>,<span class="st">&#39;marc_display.$append.note&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;544&#39;</span>,<span class="st">&#39;marc_display.$append.note&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;545&#39;</span>,<span class="st">&#39;marc_display.$append.note&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;546&#39;</span>,<span class="st">&#39;marc_display.$append.note&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;550&#39;</span>,<span class="st">&#39;marc_display.$append.note&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;555&#39;</span>,<span class="st">&#39;marc_display.$append.note&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;561&#39;</span>,<span class="st">&#39;marc_display.$append.note&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;580&#39;</span>,<span class="st">&#39;marc_display.$append.note&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;581&#39;</span>,<span class="st">&#39;marc_display.$append.publication&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;583&#39;</span>,<span class="st">&#39;marc_display.$append.note&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;586&#39;</span>,<span class="st">&#39;marc_display.$append.note&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;591&#39;</span>,<span class="st">&#39;marc_display.$append.note&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;598&#39;</span>,<span class="st">&#39;marc_display.$append.classification&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;080&#39;</span>,<span class="st">&#39;marc_display.$append.udc-no&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;082&#39;</span>,<span class="st">&#39;marc_display.$append.dewey-no&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;084&#39;</span>,<span class="st">&#39;marc_display.$append.other-call-no&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;600&#39;</span>,<span class="st">&#39;marc_display.$append.subject&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;610&#39;</span>,<span class="st">&#39;marc_display.$append.subject&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;611&#39;</span>,<span class="st">&#39;marc_display.$append.subject&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;630&#39;</span>,<span class="st">&#39;marc_display.$append.subject&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;650&#39;</span>,<span class="st">&#39;marc_display.$append.subject&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;651&#39;</span>,<span class="st">&#39;marc_display.$append.subject&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;653&#39;</span>,<span class="st">&#39;marc_display.$append.subject&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;655&#39;</span>,<span class="st">&#39;marc_display.$append.subject&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;662&#39;</span>,<span class="st">&#39;marc_display.$append.subject&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;690&#39;</span>,<span class="st">&#39;marc_display.$append.subject&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;692&#39;</span>,<span class="st">&#39;marc_display.$append.subject&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;693&#39;</span>,<span class="st">&#39;marc_display.$append.subject&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;710&#39;</span>,<span class="st">&#39;marc_display.$append.corp-author&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;711&#39;</span>,<span class="st">&#39;marc_display.$append.conference&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;730&#39;</span>,<span class="st">&#39;marc_display.$append.other-title&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;749&#39;</span>,<span class="st">&#39;marc_display.$append.title-local&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;752&#39;</span>,<span class="st">&#39;marc_display.$append.other-info&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;753&#39;</span>,<span class="st">&#39;marc_display.$append.other-info&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;772&#39;</span>,<span class="st">&#39;marc_display.$append.parent-rec-ent&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;776&#39;</span>,<span class="st">&#39;marc_display.$append.add-phys-form-e&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;777&#39;</span>,<span class="st">&#39;marc_display.$append.issu-with-entry&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;780&#39;</span>,<span class="st">&#39;marc_display.$append.preceding-entry&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;785&#39;</span>,<span class="st">&#39;marc_display.$append.succeed-entry&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;LKR&#39;</span>,<span class="st">&#39;marc_display.$append.note&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;024&#39;</span>,<span class="st">&#39;marc_display.$append.object-id&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="kw">marc_map</span>(<span class="st">&#39;856&#39;</span>,<span class="st">&#39;marc_display.$append.e-location&#39;</span>, join:<span class="st">&#39; &#39;</span>)
    <span class="co">#-if_all_match(&#39;merge.source&#39;,&#39;ser01&#39;)</span>
    <span class="co">#-    marc_map(&#39;852jhaz&#39;,&#39;marc_display.$append.location&#39;, join:&#39; | &#39;)</span>
    <span class="co">#-end</span>
    <span class="co">#-if_all_match(&#39;merge.source&#39;,&#39;rug01&#39;)</span>
    <span class="co">#-    marc_map(&#39;Z303haz&#39;,&#39;marc_display.$append.location&#39;, join:&#39; | &#39;)</span>
    <span class="co">#-end</span>
    <span class="kw">to_json</span>(<span class="st">&#39;marc_display&#39;</span>)

    <span class="co">#- Europeana Magic</span>
    <span class="fu">europeana()</span>

    <span class="co">#- MARCXML</span>
    <span class="kw">marc_xml</span>(<span class="st">&#39;record&#39;</span>)
    <span class="kw">move_field</span>(<span class="st">&#39;record&#39;</span>,<span class="st">&#39;fXML&#39;</span>)
<span class="kw">end</span>

<span class="co">#- JSON</span>
<span class="kw">to_json</span>(<span class="st">&#39;json&#39;</span>)

<span class="kw">add_field</span>(<span class="st">&#39;_bag&#39;</span>,<span class="st">&#39;data&#39;</span>)

<span class="kw">remove_field</span>(<span class="st">&#39;record&#39;</span>)
<span class="kw">remove_field</span>(<span class="st">&#39;merge&#39;</span>)
<span class="kw">remove_field</span>(<span class="st">&#39;version&#39;</span>)</code></pre>
</section>
<section id="cookbook" class="level2">
<h2><span class="header-section-number">6.4</span> Cookbook <a href="https://github.com/LibreCat/Catmandu/wiki/Cookbook">✎</a></h2>
<section id="install-catmandu-oai-processing-on-your-computer" class="level4 unnumbered">
<h4>Install Catmandu OAI processing on your computer</h4>
<p>Make sure you have <code>cpanm</code> (hint: <code>$ cpan App::cpanminus</code>) installed.</p>
<p>$ cpanm Catmandu::OAI</p>
</section>
<section id="read-dublin-core-records-from-an-oai-repository-from-the-command-line" class="level4 unnumbered">
<h4>Read Dublin Core records from an OAI repository from the command line</h4>
<ol type="1">
<li>Goto: http://www.opendoar.org/</li>
<li>Find a repository of choice</li>
<li>Read the base URL of the repository from the ‘OAI-PMH’</li>
<li>Execute in a terminal the <code>catmandu import</code> command with the URL found in the OAI-PPMH field</li>
</ol>
<p>E.g.</p>
<pre><code>$ catmandu convert OAI --url https://biblio.ugent.be/oai</code></pre>
</section>
<section id="read-dublin-core-records-from-an-oai-repository-in-your-perl-code" class="level4 unnumbered">
<h4>Read Dublin Core records from an OAI repository in your Perl code</h4>
<pre><code>use Catmandu;

Catmandu-&gt;importer(&#39;OAI&#39;,url =&gt; &#39;https://biblio.ugent.be/oai&#39;)-&gt;each(sub {
   my $record = shift;
   print &quot;$record\n&quot;;
});</code></pre>
</section>
<section id="convert-dublin-core-records-from-an-oai-repository-into-yaml-from-the-command-line" class="level4 unnumbered">
<h4>Convert Dublin Core records from an OAI repository into YAML from the command line</h4>
<pre><code>$ catmandu convert OAI --url https://biblio.ugent.be/oai to YAML</code></pre>
</section>
<section id="convert-dublin-core-records-from-an-oai-repository-into-yaml-in-your-perl-code" class="level4 unnumbered">
<h4>Convert Dublin Core records from an OAI repository into YAML in your Perl code</h4>
<pre><code>use Catmandu -all;

my $importer = importer(&#39;OAI&#39;,url =&gt; &#39;https://biblio.ugent.be/oai&#39;);
my $exporter = exporter(&#39;YAML&#39;);

$exporter-&gt;add_many($importer);
$exporter-&gt;commit;</code></pre>
</section>
<section id="extract-all-identifiers-from-an-oai-repository-from-the-command-line" class="level4 unnumbered">
<h4>Extract all identifiers from an OAI repository from the command line</h4>
<pre><code>$ catmandu convert OAI --url https://biblio.ugent.be/oai --fix &#39;retain_field(&quot;_id&quot;)&#39;</code></pre>
<p>or if you like an CSV file</p>
<pre><code>$ catmandu convert OAI --url https://biblio.ugent.be/oai to CSV --fix &#39;retain_field(&quot;_id&quot;)&#39;</code></pre>
</section>
<section id="extract-all-identifiers-from-an-oai-repository-into-csv-in-your-perl-code" class="level4 unnumbered">
<h4>Extract all identifiers from an OAI repository into CSV in your Perl code</h4>
<pre><code>use Catmandu;

my $importer = Catmandu-&gt;importer(&#39;OAI&#39;,url =&gt; &#39;https://biblio.ugent.be/oai&#39;);
my $fixer    = Catmandu-&gt;fixer(&#39;retain_field(&quot;_id&quot;)&#39;);
my $exporter = Catmandu-&gt;exporter(&#39;CSV&#39;);

$exporter-&gt;add_many(
     $fixer-&gt;fix($importer)
);

$exporter-&gt;commit;</code></pre>
</section>
<section id="show-the-speed-of-importing-records-from-the-command-line" class="level4 unnumbered">
<h4>Show the speed of importing records from the command line</h4>
<p>Hint: use the <code>-v</code> option</p>
<pre><code>$ catmandu convert -v OAI --url https://biblio.ugent.be/oai to CSV --fix &#39;retain_field(&quot;_id&quot;)&#39; &gt; /dev/null</code></pre>
<p>Here we send the output to the /dev/null to show the verbose messages.</p>
</section>
<section id="show-the-speed-of-importing-records-from-your-perl-program" class="level4 unnumbered">
<h4>Show the speed of importing records from your Perl program</h4>
<pre><code>use Catmandu;

my $importer = Catmandu-&gt;importer(&#39;OAI&#39;,url =&gt; &#39;https://biblio.ugent.be/oai&#39;);
my $fixer    = Catmandu-&gt;fixer(&#39;retain_field(&quot;_id&quot;)&#39;);
my $exporter = Catmandu-&gt;exporter(&#39;CSV&#39;);

$exporter-&gt;add_many(
     $fixer-&gt;fix($importer-&gt;benchmark)
);

$exporter-&gt;commit;</code></pre>
</section>
<section id="see-some-debug-messages" class="level4 unnumbered">
<h4>See some debug messages</h4>
<p>Make sure you have <code>Log::Log4perl</code> installed (hint: <code>$ cpan Log::Any::Adapter::Log4perl</code>).</p>
<p>In your main program do:</p>
<pre><code>use Catmandu;
use Log::Any::Adapter;
use Log::Log4perl;

Log::Any::Adapter-&gt;set(&#39;Log4perl&#39;);
Log::Log4perl::init(&#39;./log4perl.conf&#39;);

# The lines above should be enough to activate logging for Catmandu.
# Include the lines below to activate logging for your main program.
my $logger = Log::Log4perl-&gt;get_logger(&#39;myprog&#39;);

$logger-&gt;info(&quot;Starting main program&quot;);

...your code...</code></pre>
<p>with log4perl.conf like:</p>
<pre><code># Send a copy of all logging messages to STDERR
log4perl.rootLogger=DEBUG,STDERR

# Logging specific for your main program
log4perl.category.myprog=INFO,STDERR

# Logging specific for on part of Catmandu
log4perl.category.Catmandu::Fix=DEBUG,STDERR

# Where to send the STDERR output
log4perl.appender.STDERR=Log::Log4perl::Appender::Screen
log4perl.appender.STDERR.stderr=1
log4perl.appender.STDERR.utf8=1

log4perl.appender.STDERR.layout=PatternLayout
log4perl.appender.STDERR.layout.ConversionPattern=%d [%P] - %p %l time=%r : %m%n</code></pre>
<p>You will see now Catmandu log messages (e.g. for Fixes).</p>
<p>If you want to add logging functionality in your own Perl modules you have two options;</p>
<ol type="1">
<li><p>Your package is a Catmandu::Importer or Catmandu::Exporter. In this case you are lucky because you have a logger as part of your instance:</p>
<p>$self-&gt;log-&gt;debug(‘blablabla’); # where $self is an Importer,Fix or Exporter instance</p></li>
<li><p>You need to create the logger yourself.</p>
<p>package Foo::Bar;</p>
<p>use Moo;</p>
<p>with ‘Catmandu::Logger’;</p>
<p>sub bar { my $self = shift; $self-&gt;log-&gt;debug(‘tadaah’); }</p></li>
</ol>
<p>If you want to see the logging messages only of your package, then use a this type of line in your log4perl.conf:</p>
<pre><code>log4perl.category.Foo::Bar=DEBUG,STDOUT</code></pre>
<p>or if you want to see all the log messages for Foo packages:</p>
<pre><code>log4perl.category.Foo=DEBUG,STDOUT </code></pre>
</section>
<section id="how-to-create-a-new-catmandustore" class="level4 unnumbered">
<h4>How to create a new Catmandu::Store</h4>
<p>A Catmandu::Store is used to store items. Stores can have one or more compartments where to store the items. Each such compartment is a Catmandu::Bag. You can compare a Store with a database and a Bag with a table in a database. Like tables, Bags have names. When no name is provided for a Bag, then ‘data’ is used.</p>
<p>To implement a Catmandu store you need to create at least two packages:</p>
<ol type="1">
<li>A ‘Catmandu::Store’, defining the general parameters, possible connection parameters and actions for the whole store.</li>
<li>A ‘Catmandu::Bag’, which is used to list, add,fetch and delete items from a Bag.</li>
</ol>
<p>As example, this is a skeleton for a ‘Foo’ Catmandu::Store which requires at least one ‘foo’ connection parameter:</p>
<pre><code>package Catmandu::Store::Foo;
use Moo;

use Catmandu::Store::Foo::Bag;

with &#39;Catmandu::Store&#39;;

has &#39;foo&#39; =&gt; (is =&gt; &#39;ro&#39; , required =&gt; 1);

1;</code></pre>
<p>For this Catmandu::Store::Foo we can define a module ‘Catmandu::Store::Foo::Bag’ to implement the Bag functions. Notice how in the generator the bag can access the Catmandu::Store instance:</p>
<pre><code>package Catmandu::Store::Foo::Bag;
use Moo;

with &#39;Catmandu::Bag&#39;;

sub generator {
    my $self = shift;
    sub {
        # This subroutine is used to loop over all items
        # in a store and should return a item HASH for
        # every call
        return { 
             name =&gt; $self-&gt;name,
             foo =&gt; $self-&gt;store-&gt;foo 
       };
    };
}

sub get {
    my ($self,$id) = @_;
    # return a item HASH given an $id
    return {};
}

sub add {
    my ($self,$data) = @_;
    # add/update an item HASH to the bag and return the item with an _id field set
    return $data;
}

sub delete {
    my ($self,$id) = @_;
    # delete an item from the bag given an $id
    1;
}

sub delete_all {
    my ($self) = @_;
    # delete all items
    $self-&gt;each(sub {
        $self-&gt;delete($_[0]-&gt;{_id});
    });
}

1;</code></pre>
<p>With this skeleton Store you have enough code to run basic tests. Save these package in a lib directory:</p>
<p>lib/Catmandu/Store/Foo.pm lib/Catmandu/Store/Foo/Bag.pm</p>
<p>and a <code>catmandu</code> command to test your implementation:</p>
<p>$ catmandu -I lib export Foo –foo bar</p>
<p>{“foo”:“bar”,“name”:“data”} {“foo”:“bar”,“name”:“data”} {“foo”:“bar”,“name”:“data”} . . .</p>
<p>Or create a test.pl script to access your new Store via Perl:</p>
<pre><code>#!/usr/bin/env perl
use lib qw(./lib);
use Catmandu;

my $store = Catmandu-&gt;store(&#39;Foo&#39;, foo =&gt; &#39;bar&#39;);

$store-&gt;add({ test =&gt; 123});</code></pre>
</section>
</section>
</section>
<section id="api" class="level1">
<h1><span class="header-section-number">7</span> API <a href="https://github.com/LibreCat/Catmandu/wiki/API">✎</a></h1>
<p>This section will provide an in depth overview how to extend Catmandu using the API</p>
<section id="fix-packages" class="level2">
<h2><span class="header-section-number">7.1</span> Fix packages <a href="https://github.com/LibreCat/Catmandu/wiki/Fix%20packages">✎</a></h2>
<section id="create-a-simple-fix" class="level4 unnumbered">
<h4>Create a simple Fix</h4>
<p>The easiest way to create a new ‘Fix’ is by creating a Perl package in the Catmandu::Fix namespace that has a ‘fix’ instance method. For example:</p>
<pre class="sourceCode perl"><code class="sourceCode perl"><span class="kw">package</span> <span class="fu">Catmandu::Fix</span>::<span class="fu">foo</span>;

<span class="fu">use</span> Moo;

<span class="kw">sub </span><span class="fu">fix</span> {
    <span class="kw">my</span> (<span class="dt">$self</span>, <span class="dt">$data</span>) = <span class="dt">@_</span>;

    <span class="co"># modify your data here, for instance...</span>
    <span class="dt">$data</span>-&gt;{foo} = <span class="kw">&#39;</span><span class="st">bar</span><span class="kw">&#39;</span>;

    <span class="dt">$data</span>;
}

<span class="dv">1</span>;</code></pre>
<p>When this code is available in your perl library path as <code>Catmandu/Fix/foo.pm</code> it can be used as fix function <code>foo()</code>. To try out save the file as <code>lib/Catmandu/Fix/foo.pm</code> in your local directory and execute:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">echo</span> <span class="st">&#39;{}&#39;</span> <span class="kw">|</span> <span class="kw">catmandu</span> -I lib convert JSON --fix <span class="st">&quot;foo()&quot;</span>
<span class="dt">{&quot;foo&quot;:&quot;bar&quot;}</span></code></pre>
</section>
<section id="fix-creation-with-helper-packages" class="level4 unnumbered">
<h4>Fix creation with helper packages</h4>
<p><em>The following instruction is incomplete, see POD of Catmandu::Fix</em></p>
<p>If you want pass arguments to your fix, you can make use of Moo and Catmandu::Fix::Has to read in required and optional parameters.</p>
<pre class="sourceCode perl"><code class="sourceCode perl"><span class="kw">package</span> <span class="fu">Catmandu::Fix</span>::<span class="fu">foo</span>;

<span class="fu">use</span> Moo;

has greeting =&gt; (fix_arg =&gt; <span class="dv">1</span>);  <span class="co"># required first argument</span>
has message  =&gt; (fix_arg =&gt; <span class="dv">1</span>);  <span class="co"># required second argument</span>
has eol      =&gt; (fix_opt =&gt; <span class="dv">1</span>, <span class="kw">default</span> =&gt; <span class="kw">sub </span>{ <span class="kw">&#39;</span><span class="st">!</span><span class="kw">&#39;</span> });  <span class="co"># optional argument , default &#39;!&#39;</span>

<span class="kw">sub </span><span class="fu">fix</span> {
    <span class="kw">my</span> (<span class="dt">$self</span>,<span class="dt">$data</span>) = <span class="dt">@_</span>;

    <span class="dt">$self</span>-&gt;<span class="dt">log</span>-&gt;<span class="dt">debug</span>(<span class="dt">$self</span>-&gt;<span class="dt">greeting</span> . <span class="kw">&quot;</span><span class="st">, </span><span class="kw">&quot;</span> . <span class="dt">$self</span>-&gt;<span class="dt">message</span> .  <span class="dt">$self</span>-&gt;<span class="dt">eol</span>. <span class="kw">&quot;</span><span class="ch">\n</span><span class="kw">&quot;</span>;

    <span class="co"># Fix your data here...</span>

    <span class="dt">$data</span>;
}

<span class="dv">1</span>;</code></pre>
<p>Now you can write log messages in your Fixes:</p>
<pre><code>$ echo &#39;{}&#39; | catmandu convert --fix &#39;foo(Hello,World)&#39;
Hello, World!
{}
$ echo &#39;{}&#39; | catmandu convert --fix &#39;foo(Hello,World, eol: ?)&#39;
Hello, World?
{}</code></pre>
<p>See also Catmandu::Fix::SimpleGetValue.</p>
</section>
<section id="extended-introduction" class="level4 unnumbered">
<h4>Extended introduction</h4>
<p>For an extended introduction into creating Fix packages read the two blog posts at:</p>
<ul>
<li><a href="#-http://librecat.org/catmandu/2014/03/14/create-a-fixer.html">Create a fixer - Part 1</a></li>
<li><a href="#-http://librecat.org/catmandu/2014/03/26/creating-a-fixer-2.html">Create a fixer - Part 2</a></li>
</ul>
</section>
</section>
</section>
<section id="contribution" class="level1">
<h1><span class="header-section-number">8</span> Contribution <a href="https://github.com/LibreCat/Catmandu/wiki/Contribution">✎</a></h1>
<p>This guide has been written to help anyone interested in contributing to the development of Catmandu. Please read this guide before contributing to Catmandu or related projects, to avoid wasted effort and maximizing the chances of your contributions being used.</p>
<section id="ways-to-contribute" class="level2">
<h2><span class="header-section-number">8.1</span> Ways to contribute</h2>
<p>There are many ways to contribute to the project. Catmandu is a young yet active project and any kind of help is very much appreciated!</p>
<section id="publicity" class="level3">
<h3><span class="header-section-number">8.1.1</span> Publicity</h3>
<p>You don’t have to start by hacking the code, spreading the word is very valuable as well!</p>
<p>If you have a blog, just feel free to speak about Catmandu.</p>
<p>Of course, it doesn’t have to be limited to blogs or Twitter. Feel free to spread the word in whatever way you consider fit and drop us a line on the Catmandu user mailing list noted below.</p>
<p>Also, if you’re using and enjoying Catmandu, <a href="http://cpanratings.perl.org/dist/Catmandu">rating us on cpanratings.perl.org</a>, explaining what you like about Catmandu is another very valuable contribution that helps other new users find us!</p>
</section>
<section id="mailing-list" class="level3">
<h3><span class="header-section-number">8.1.2</span> Mailing list</h3>
<p>Subscribing to the mailing list and providing assistance to new users is incredibly valuable.</p>
<ul>
<li>Mailing list: <code>librecat-dev@lists.uni-bielefeld.de</code></li>
<li>Subscribe or view archives here: <a href="https://lists.uni-bielefeld.de/mailman2/cgi/unibi/listinfo/librecat-dev" class="uri">https://lists.uni-bielefeld.de/mailman2/cgi/unibi/listinfo/librecat-dev</a></li>
</ul>
</section>
<section id="documentation" class="level3">
<h3><span class="header-section-number">8.1.3</span> Documentation</h3>
<p>We value documentation very much, but it’s difficult to keep it up-to-date. If you find a typo or an error in the documentation please do let us know - ideally by submitting a patch (pull request) with your fix or suggestion (see <a href="#patch-submission">Patch Submission</a>).</p>
</section>
<section id="code" class="level3">
<h3><span class="header-section-number">8.1.4</span> Code</h3>
<p>To can contribute to Catmandu’s core code or extend the functionality by new <a href="#importers">Importers</a>, <a href="#exporters">Exporters</a>, <a href="#stores">Stores</a>, <a href="#fix-packages">Fix packages</a>, <a href="#validators">Validators</a>, <a href="#binds">Binds</a>, or <a href="#plugins">Plugins</a>. Have a look at the list of <a href="#missing-modules">missing modules</a> for existing ideas and resources for new Catmandu modules. Feel also free to add new ideas and links there.</p>
<p>For more detailed guidelines, see:</p>
<ul>
<li><a href="#development-setup">development setup</a> for how to set up a development environment</li>
<li><a href="#patch-submission">patch submission</a> for how to submit patches using the GitHub workflow</li>
<li><a href="#coding-guidelines">coding guidelines</a> for how to write readable code and documentation</li>
</ul>
</section>
</section>
<section id="quality-supervision-and-reporting-bugs" class="level2">
<h2><span class="header-section-number">8.2</span> Quality Supervision and Reporting Bugs</h2>
<p>We can measure our quality using the CPAN testers platform: <a href="http://www.cpantesters.org" class="uri">http://www.cpantesters.org</a>.</p>
<p>A good way to help the project is to find a failing build log on the CPAN testers: <a href="http://www.cpantesters.org/distro/D/Catmandu.html" class="uri">http://www.cpantesters.org/distro/D/Catmandu.html</a></p>
<p>If you find a failing test report or another kind of bug, feel free to report it as a GitHub issue: <a href="http://github.com/LibreCat/Catmandu/issues" class="uri">http://github.com/LibreCat/Catmandu/issues</a>. Please make sure the bug you’re reporting does not yet exist.</p>
</section>
<section id="resources-for-developers" class="level2">
<h2><span class="header-section-number">8.3</span> RESOURCES FOR DEVELOPERS</h2>
<section id="website" class="level3">
<h3><span class="header-section-number">8.3.1</span> Website</h3>
<p>The official website is here: <a href="http://librecat.org/" class="uri">http://librecat.org/</a> A Wordpress blog with hints is available at: <a href="https://librecatproject.wordpress.com/" class="uri">https://librecatproject.wordpress.com/</a></p>
</section>
<section id="mailing-lists" class="level3">
<h3><span class="header-section-number">8.3.2</span> Mailing Lists</h3>
<p>A mailing list is available here: <code>librecat-dev@mail.librecat.org</code></p>
</section>
<section id="repositories" class="level3">
<h3><span class="header-section-number">8.3.3</span> Repositories</h3>
<p>The official repository is hosted on GitHub at <a href="http://github.com/LibreCat/Catmandu" class="uri">http://github.com/LibreCat/Catmandu</a>.</p>
<p>Official developers have write access to this repository, contributors are invited to fork the dev branch (!) and submit a pull request, as described at <a href="#patch-submission">patch submission</a>.</p>
</section>
<section id="core-maintainers" class="level3">
<h3><span class="header-section-number">8.3.4</span> Core Maintainers</h3>
<ul>
<li><strong>LibreCat/Catmandu</strong> - <span class="citation" data-cites="nics">@nics</span></li>
<li><strong>LibreCat/Catmandu-AWS</strong> - <span class="citation" data-cites="phochste">@phochste</span></li>
<li><strong>LibreCat/Catmandu-AlephX</strong> - <span class="citation" data-cites="nicolasfranck">@nicolasfranck</span></li>
<li><strong>LibreCat/Catmandu-ArXiv</strong> - <span class="citation" data-cites="pietsch">@pietsch</span>, <span class="citation" data-cites="vpeil">@vpeil</span></li>
<li><strong>LibreCat/Catmandu-Atom</strong> - <span class="citation" data-cites="phochste">@phochste</span></li>
<li><strong>LibreCat/Catmandu-BibTeX</strong> - <span class="citation" data-cites="pietsch">@pietsch</span>, <span class="citation" data-cites="vpeil">@vpeil</span></li>
<li><strong>LibreCat/Catmandu-Cmd-fuse</strong> - <span class="citation" data-cites="nics">@nics</span></li>
<li><strong>LibreCat/Catmandu-Cmd-repl</strong> - <span class="citation" data-cites="pietsch">@pietsch</span></li>
<li><strong>LibreCat/Catmandu-CrossRef</strong> <span class="citation" data-cites="pietsch">@pietsch</span>, <span class="citation" data-cites="vpeil">@vpeil</span></li>
<li><strong>LibreCat/Catmandu-DBI</strong> - <span class="citation" data-cites="nicolasfranck">@nicolasfranck</span></li>
<li><strong>LibreCat/Catmandu-DSpace</strong> - <span class="citation" data-cites="nicolasfranck">@nicolasfranck</span></li>
<li><strong>LibreCat/Catmandu-EuropePMC</strong> - <span class="citation" data-cites="vpeil">@vpeil</span></li>
<li><strong>LibreCat/Catmandu-Exporter-ODS</strong> - <span class="citation" data-cites="snorri">@snorri</span></li>
<li><strong>LibreCat/Catmandu-Exporter-RTF</strong> - <span class="citation" data-cites="petrakohorst">@petrakohorst</span></li>
<li><strong>LibreCat/Catmandu-Exporter-Template</strong> - <span class="citation" data-cites="vpeil">@vpeil</span></li>
<li><strong>LibreCat/Catmandu-FedoraCommons</strong> - <span class="citation" data-cites="phochste">@phochste</span></li>
<li><strong>LibreCat/Catmandu-Fix-XML</strong> - <span class="citation" data-cites="nichtich">@nichtich</span></li>
<li><strong>LibreCat/Catmandu-Fix-cmd</strong> - <span class="citation" data-cites="nichtich">@nichtich</span></li>
<li><strong>LibreCat/Catmandu-Importer-CPAN</strong> - <span class="citation" data-cites="nichtich">@nichtich</span> <span class="citation" data-cites="phochste">@phochste</span></li>
<li><strong>LibreCat/Catmandu-Importer-Parltrack</strong> - <span class="citation" data-cites="jonas">@jonas</span></li>
<li><strong>LibreCat/Catmandu-Inspire</strong> - <span class="citation" data-cites="vpeil">@vpeil</span></li>
<li><strong>LibreCat/Catmandu-LDAP</strong> - <span class="citation" data-cites="nics">@nics</span></li>
<li><strong>LibreCat/Catmandu-MARC</strong> - <span class="citation" data-cites="phochste">@phochste</span></li>
<li><strong>LibreCat/Catmandu-MediaMosa</strong> - <span class="citation" data-cites="nicolasfranck">@nicolasfranck</span></li>
<li><strong>LibreCat/Catmandu-OAI</strong> - <span class="citation" data-cites="pietsch">@pietsch</span>, <span class="citation" data-cites="phochste">@phochste</span></li>
<li><strong>LibreCat/Catmandu-ORCID</strong> - <span class="citation" data-cites="pietsch">@pietsch</span></li>
<li><strong>LibreCat/Catmandu-PLoS</strong> - <span class="citation" data-cites="pietsch">@pietsch</span>, <span class="citation" data-cites="vpeil">@vpeil</span></li>
<li><strong>LibreCat/Catmandu-Plack-REST</strong> - <span class="citation" data-cites="phochste">@phochste</span></li>
<li><strong>LibreCat/Catmandu-PubMed</strong> - <span class="citation" data-cites="pietsch">@pietsch</span>, <span class="citation" data-cites="vpeil">@vpeil</span></li>
<li><strong>LibreCat/Catmandu-Pure</strong> - <span class="citation" data-cites="snorri">@snorri</span></li>
<li><strong>LibreCat/Catmandu-RDF</strong> - <span class="citation" data-cites="nichtich">@nichtich</span></li>
<li><strong>LibreCat/Catmandu-SRU</strong> - <span class="citation" data-cites="pietsch">@pietsch</span></li>
<li><strong>LibreCat/Catmandu-Serializer-messagepack</strong> - <span class="citation" data-cites="nicolasfranck">@nicolasfranck</span></li>
<li><strong>LibreCat/Catmandu-Serializer-storable</strong> - <span class="citation" data-cites="nics">@nics</span></li>
<li><strong>LibreCat/Catmandu-Store-CouchDB</strong> - <span class="citation" data-cites="nics">@nics</span></li>
<li><strong>LibreCat/Catmandu-Store-Elasticsearch</strong> - <span class="citation" data-cites="nics">@nics</span></li>
<li><strong>LibreCat/Catmandu-Store-Lucy</strong> - <span class="citation" data-cites="nics">@nics</span></li>
<li><strong>LibreCat/Catmandu-Store-MongoDB</strong> - <span class="citation" data-cites="nics">@nics</span></li>
<li><strong>LibreCat/Catmandu-Store-Solr</strong> - <span class="citation" data-cites="nicolasfranck">@nicolasfranck</span> , <span class="citation" data-cites="nics">@nics</span></li>
<li><strong>LibreCat/Catmandu-Twitter</strong> - <span class="citation" data-cites="pietsch">@pietsch</span></li>
<li><strong>LibreCat/Catmandu-XLS</strong> - <span class="citation" data-cites="jorol">@jorol</span>, <span class="citation" data-cites="nics">@nics</span></li>
<li><strong>LibreCat/Catmandu-Z3950</strong> - <span class="citation" data-cites="pietsch">@pietsch</span></li>
<li><strong>LibreCat/Dancer-Plugin-Auth-RBAC-Credentials-Catmandu</strong> - <span class="citation" data-cites="nicolasfranck">@nicolasfranck</span></li>
<li><strong>LibreCat/Dancer-Plugin-Catmandu-OAI</strong> - <span class="citation" data-cites="nicolasfranck">@nicolasfranck</span></li>
<li><strong>LibreCat/Dancer-Plugin-Catmandu-SRU</strong> - <span class="citation" data-cites="nics">@nics</span>, phochste</li>
<li><strong>LibreCat/Dancer-Session-Catmandu</strong> - <span class="citation" data-cites="nics">@nics</span></li>
<li><strong>LibreCat/LibreCat-Sitemap</strong> - <span class="citation" data-cites="phochste">@phochste</span></li>
<li><strong>LibreCat/MODS-Record</strong> - <span class="citation" data-cites="phochste">@phochste</span></li>
<li><strong>LibreCat/Plack-Session-Store-Catmandu</strong> - <span class="citation" data-cites="nics">@nics</span></li>
<li><strong>LibreCat/Task-Catmandu</strong> - <span class="citation" data-cites="nics">@nics</span></li>
<li><strong>LibreCat/WWW-ORCID</strong> - <span class="citation" data-cites="nics">@nics</span></li>
</ul>
</section>
</section>
<section id="acknowledgement" class="level2">
<h2><span class="header-section-number">8.4</span> Acknowledgement</h2>
<p>This guide was based on <Dancer2::Development>.</p>
</section>
<section id="development-setup" class="level2">
<h2><span class="header-section-number">8.5</span> Development Setup <a href="https://github.com/LibreCat/Catmandu/wiki/Development%20Setup">✎</a></h2>
<p>The following guidelines describe how to set up a development environment for <a href="#contribution">contribution</a> of code.</p>
<section id="set-up-a-development-environment" class="level3">
<h3><span class="header-section-number">8.5.1</span> Set up a development environment</h3>
<p>If you want to submit a patch for Catmandu, you need git and very likely also <code>milla</code> (<Dist::Milla>). We also recommend perlbrew (see below) to test and develop Catmandu on a recent version of perl. We also suggest <App::cpanminus>) to quickly and comfortably install perl modules under perlbrew.</p>
<p>In the following sections we provide tips for the installation of some of these tools together with Catmandu. Please also see the documentation that comes with these tools for more info.</p>
<section id="perlbrew-tips-optional" class="level4 unnumbered">
<h4>Perlbrew tips (Optional)</h4>
<p>Install perlbrew for example with</p>
<pre><code>cpanm App::perlbrew</code></pre>
<p>Check which perls are available</p>
<pre><code>perlbrew available</code></pre>
<p>At the time of writing it looks like this</p>
<pre><code>perl-5.18.0
perl-5.16.3
perl-5.14.4
perl-5.12.5
perl-5.10.1
perl-5.8.9
perl-5.6.2
perl5.005_04
perl5.004_05
perl5.003_07</code></pre>
<p>Then go on and install a version inside Perlbrew. I recommend you give a name to the installation (<code>--as</code> option), as well as compiling without the tests (<code>--n</code> option) to speed it up.</p>
<pre><code>perlbrew install -n perl-5.16.3 --as catmandu_dev -j 3</code></pre>
<p>Wait a while, and it should be done. Switch to your new Perl with:</p>
<pre><code>perlbrew switch catmandu_dev</code></pre>
<p>Now you are using the fresh Perl, you can check it with:</p>
<pre><code>which perl</code></pre>
<p>Install cpanm on your brewed version of perl.</p>
<pre><code>perlbrew install-cpanm</code></pre>
</section>
</section>
<section id="install-dependencies-required" class="level3">
<h3><span class="header-section-number">8.5.2</span> Install dependencies (required)</h3>
<p><em>this section needs to be rewritten to reflect the change to <a href="https://metacpan.org/pod/Dist::Milla">Dist::Milla</a></em></p>
</section>
<section id="get-catmandu-sources" class="level3">
<h3><span class="header-section-number">8.5.3</span> Get Catmandu sources</h3>
<p>Get the Catmandu sources from github (for a more complete git workflow see below):</p>
<p>Clone your fork to have a local copy using the following command:</p>
<pre><code>$ git clone git@github.com:LibreCat/Catmandu.git</code></pre>
<p>The installation is then straight forward:</p>
<pre><code>$ cd Catmandu
$ perl Build.PL
$ ./Build
$ ./Build test
$ ./Build install</code></pre>
<p>You can now start with hacking Catmandu and <a href="#patch-submission">patch submission</a>!</p>
</section>
</section>
<section id="coding-guidelines" class="level2">
<h2><span class="header-section-number">8.6</span> Coding guidelines <a href="https://github.com/LibreCat/Catmandu/wiki/Coding%20guidelines">✎</a></h2>
<p>The following guidelines are no strict rules but they should be considered as best practice for <a href="#contribution">contribution</a>.</p>
</section>
<section id="compatibility" class="level2">
<h2><span class="header-section-number">8.7</span> Compatibility</h2>
<p>Catmandu should be able to install for all Perl versions since 5.10.1, on any platform for which Perl exists. We focus mainly on GNU/Linux (any distribution).</p>
<p>You should avoid regressions as much as possible and keep backwards compatibility in mind when refactoring. Stable releases should not break functionality and new releases should provide an upgrade path and upgrade tips such as warning the user about deprecated functionality.</p>
</section>
<section id="code-documentation" class="level2">
<h2><span class="header-section-number">8.8</span> Code documentation</h2>
<p>Document your module with</p>
<ul>
<li>a meaningful abstract</li>
<li>a SYNOPSIS with usage example</li>
<li>a short DESCRIPTION giving an introduction, including explicit links to other modules (e.g. roles)</li>
<li>a CONFIGURATION section listing all constructor arguments</li>
<li>a METHODS section listing all public methods. Methods derived from other modules should not be included but the modules should be mentioned explicitly.</li>
<li>a SEE ALSO section listing related modules</li>
</ul>
<p>Names of other moduless should be linked (e.g. <code>L&lt;Catmandu::Importer&gt;</code>)</p>
</section>
<section id="patch-submission" class="level2">
<h2><span class="header-section-number">8.9</span> Patch Submission <a href="https://github.com/LibreCat/Catmandu/wiki/Patch%20Submission">✎</a></h2>
<p>The Catmandu development team uses GitHub to collaborate. We greatly appreciate <a href="Contribution">contributions</a> submitted via GitHub, as it makes tracking these contributions and applying them much, much easier. This gives your contribution a much better chance of being integrated into Catmandu quickly!</p>
<p>To help us achieve high-quality, stable releases, git-flow workflow is used to handle pull-requests, that means contributors must work on their <code>dev</code> branch rather than on their <code>master</code>. (Master should be touched only by the core dev team when preparing a release to CPAN; all ongoing development happens in branches which are merged to the <code>dev</code> branch.)</p>
<p>Here is the workflow for submitting a patch:</p>
<ol type="1">
<li><p>Fork the repository <a href="http://github.com/LibreCat/Catmandu" class="uri">http://github.com/LibreCat/Catmandu</a> (click “Fork”)</p></li>
<li><p>Clone your fork to have a local copy using the following command:</p>
<pre><code>$ git clone git://github.com/$myname/Catmandu.git</code></pre></li>
<li><p>As a contributor, you should <strong>always</strong> work on the <code>dev</code> branch of your clone (<code>master</code> is used only for building releases).</p>
<pre><code>$ git remote add upstream https://github.com/LibreCat/Catmandu.git
$ git fetch upstream
$ git checkout -b dev upstream/dev</code></pre></li>
</ol>
<p>This will create a local branch in your clone named <code>dev</code> and that will track the official <code>dev</code> branch. That way, if you have more or less commits than the upstream repo, you’ll be immediately notified by git.</p>
<ol start="4" type="1">
<li>You want to isolate all your commits in a <code>topic</code> branch, this will make the reviewing much easier for the core team and will allow you to continue working on your clone without worrying about different commits mixing together.</li>
</ol>
<p>To do that, first create a local branch to build your pull request:</p>
<pre><code>    # you should be in dev branch here
    git checkout -b pr/$name</code></pre>
<p>Now you have created a local branch named <code>pr/$name</code> where I&lt;$name&gt; is the name you want (it should describe the purpose of the pull request you’re preparing).</p>
<ol start="5" type="1">
<li><p>In that branch, do all the commits you need (the more the better) and when done, push the branch to your fork:</p>
<p># … commits … git push origin pr/$name</p></li>
</ol>
<p>You are now ready to send a pull request.</p>
<ol start="6" type="1">
<li>Send a <code>pull request</code> via the GitHub interface. Make sure your pull request is based on the <code>pr/$name</code> branch you’ve just pushed, so that it incorporates the appropriate commits only.</li>
</ol>
<p>It’s also a good idea to summarize your work in a report sent to the users mailing list (see below), in order to make sure the team is aware of it.</p>
<p>When the core team reviews your pull request, it will either accept (and then merge into <code>dev</code>) or refuse your request.</p>
<p>If it’s refused, try to understand the reasons explained by the team for the denial. Most of the time, communicating with the core team is enough to understand what the mistake was. Above all, please don’t be offended.</p>
<ol start="7" type="1">
<li><p>If your pull-request is merged into <code>dev</code>, then all you have to do is to remove your local and remote <code>pr/$name</code> branch:</p>
<pre><code>git checkout dev
git branch -D pr/$name
git push origin :pr/$name</code></pre></li>
<li><p>And then, of course, you need to sync your local dev branch with the upstream:</p>
<pre><code>git pull upstream dev
git push origin dev</code></pre></li>
</ol>
<p>You’re now ready to start working on a new pull request!</p>
</section>
</section>
<section id="related-projects" class="level1">
<h1><span class="header-section-number">9</span> Related Projects <a href="https://github.com/LibreCat/Catmandu/wiki/Related%20Projects">✎</a></h1>
<p>Here we provide a list of related projects that also provide ETL/data processing tools.</p>
<section id="selected-formats" class="level2">
<h2><span class="header-section-number">9.1</span> selected formats</h2>
<ul>
<li><a href="http://cocoon.apache.org/2.2/1290_1_1.html">Cocoon</a> - Apache Cocoon XML pipeline</li>
<li><a href="https://csvkit.readthedocs.org/en/0.9.1/">csvkit</a> - Csvkit is a suite of utilities for converting to and working with CSV, the king of tabular file formats.</li>
<li><a href="https://www.gnu.org/software/datamash/manual/datamash.html">Datamash</a> - performs calculation (e.g. sum,, count, min, max, skewness, standard deviation) on input files.</li>
<li><a href="http://sourceforge.net/projects/dnb-conv-tools/?source=navbar">DNB-Conv-Tools</a> - Java conversion tools for MARC, ONIX, MAB, Pica and others</li>
<li>easyM2R - https://github.com/cKlee/easyM2R</li>
<li><a href="https://metacpan.org/release/ETL-Yertl">ETL-Yertl</a></li>
<li><a href="http://stedolan.github.io/jq/">jq</a></li>
<li><a href="https://github.com/libris/librisxl/">Librisxl</a> - Tools for conversion of libris.kb.se data</li>
<li><a href="https://www.kobv.de/entwicklung/software/mable/">MABLE</a> - MABLE+ ist ein Java-gestütztes Software-Tool zur automatischen Daten- und Fehleranalyse von Bibliothekskatalogen.</li>
<li><a href="http://www.dnb.de/DE/Standardisierung/Formate/MABxml/mabxml_node.html">MABTools</a> - MAB tools created by the Deutschen Nationalbibliothek</li>
<li>MARCEdit - http://marcedit.reeset.net/</li>
<li><a href="http://en.pusc.it/bib/MARCgrep">MARCgrep.pl</a> - MARCgrep.pl is a Perl script to filter or count bibliographic records based on condition built upon tag name, indicators, subfield, field value (or tag, positions, value for control fields 00x).</li>
<li>marc2rdf - https://github.com/digibib/marc2rdf (uses JSON mappings <a href="https://github.com/digibib/marc2rdf/blob/master/config/templates/mappings.json">such as this</a>)</li>
<li>MARCspec - http://cklee.github.io/marc-spec/marc-spec.html (mapping language for MARC)</li>
<li>marctools - https://github.com/ubleipzig/marctools (various MARC command line utilities)</li>
<li><a href="http://mayor2.dia.fi.upm.es/oeg-upm/index.php/en/technologies/228-marimba">MARiMbA</a> - is a command-line tool, designed with librarians in mind, to transform MARC (MAchine-Readable Cataloging) records to RDF</li>
<li><a href="https://github.com/johnkerl/miller">miller</a> - is like sed, awk, cut, join, and sort for name-indexed data such as CSV and tabular JSON</li>
<li><a href="https://github.com/edsu/pymarc">pymarc</a> - pymarc is a python library for working with bibliographic data encoded in MARC21</li>
<li>solrmarc - https://code.google.com/p/solrmarc/</li>
<li><a href="https://github.com/tarql/tarql/wiki/TARQL-Mapping-Language">TARQL</a> - a SPARQL-based data mapping language to convert CSV, XML, JSON to RDF</li>
<li><a href="https://github.com/traject/traject">Traject</a> - an easy to use, high-performance, flexible and extensible MARC to Solr indexer.</li>
</ul>
</section>
<section id="general-frameworks" class="level2">
<h2><span class="header-section-number">9.2</span> general frameworks</h2>
<ul>
<li><a href="http://akara.info/">Akara</a> - Akara is a platform for developing data services available on the Web, using REST architecture. Akara is open source software written in Python and C</li>
<li><a href="https://github.com/benbernard/RecordStream">App::RecordStream</a> - App::RecordStream - recs - A system for command-line analysis of data.</li>
<li><a href="https://attx-project.github.io/ETL-Artifacts.html">ATTX</a> - Putting Linked Data to Work (University of Helsinki)</li>
<li><a href="https://haskell-lang.org/library/conduit">Conduit</a> - Haskell framework for dealing with streaming data</li>
<li><a href="http://www.comsode.eu/">COMSODE</a> - The project COMSODE is an SME-driven RTD project aimed at progressing the capabilities in the field of Open Data re-use.</li>
<li><a href="http://www.d-net.research-infrastructures.eu/node/43">DNet</a></li>
<li><a href="http://dmp.slub-dresden.de/en/datenmanagement/">d:swarm</a> - data management platform for enrichment, normalization and linkage of knowledge data structures.</li>
<li><a href="https://metacpan.org/pod/ETL::Yertl">ETL::Yertl</a> - ETL with a Shell</li>
<li><a href="https://github.com/dpla/heidrun">Heiðrún</a> - Heiðrún is the DPLA metadata ingestion and QA system, and is an implementation of the Kri-kri Rails engine.</li>
<li><a href="https://code.google.com/p/jaql/">JAQL</a> - Query Language for JavaScript(r) Object Notation (JSON)</li>
<li><a href="https://www.knime.com/knime-analytics-platform">KNIME</a> - Open source Analytics Platform</li>
<li><a href="https://github.com/dpla/KriKri">Krikri</a> - DPLA Ruby on Rails engine for metadata aggregation, enhancement and quality control.</li>
<li><a href="https://github.com/flaxsearch/luwak">Luwak</a> - A Lucene extention to search data streams. See also <a href="http://blog.confluent.io/2015/04/13/real-time-full-text-search-with-luwak-and-samza/">this</a> blog entry.</li>
<li>Metadata Interoperability Framework (MIF) - http://elag2014.org/programme/elag-workshops-list-page/11-5/ <a href="https://elag2014.files.wordpress.com/2014/06/11-5-alloing-s-mif.pptx">PPT</a></li>
<li><a href="http://mint.image.ece.ntua.gr/redmine/projects/mint/wiki">MINT</a> - Metadata Interoperability Services</li>
<li><a href="https://github.com/seecr?query=meresco">Meresco</a> - Under the Meresco name Dutch public institutions share quality software components related to metadata management and search.</li>
<li><a href="https://github.com/ubpb/metacrunch">Metacrunch</a></li>
<li><a href="https://github.com/culturegraph/metafacture-core/wiki">metafacture</a> - used in <a href="http://culturegraph.github.io">culturegraph</a></li>
<li><a href="https://code.google.com/p/xcmetadataservicestoolkit/">Metadata Services Toolkit</a> - part of the eXtensible Catalog (XC)</li>
<li><a href="http://more.dcu.gr/">Metadata &amp; Object Repository (MoRe)</a></li>
<li><a href="https://github.com/walmartlabs/mupd8">MUPD8</a> - Data stream processing from Wallmartlabs.</li>
<li><a href="http://openrefine.org/">OpenRefine</a> - (formerly Google Refine) a toolkit to work with tabular data.</li>
<li><a href="https://petl.readthedocs.org/en/latest/">Petl</a> - Python ETL library</li>
<li><a href="http://pig.apache.org/">Pig</a> - Apache Pig is a platform for analyzing large data sets that consists of a high-level language for expressing data analysis programs, coupled with infrastructure for evaluating these programs.</li>
<li><a href="https://github.com/dailyburn/ratchet">Ratchet</a> - A library for performing data pipeline / ETL tasks in Go.</li>
<li><a href="http://repox.ist.utl.pt/">REPOX</a> - Data Aggregation and Interoperability Manager</li>
<li><a href="http://samza.apache.org/">Samza</a> - Apache Samza is a distributed stream processing framework.</li>
<li><a href="https://www.assembla.com/wiki/show/silk/Silk_Single_Machine">Silk</a> - The Silk framework provides a declarative language for specifying which types of RDF links should be discovered between data sources as well as which conditions data items must fulfil in order to be interlinked.</li>
<li><a href="http://spark.apache.org/docs/latest/streaming-programming-guide.html">Spark Streaming</a> - Spark Streaming is an extension of the core Spark API that enables scalable, high-throughput, fault-tolerant stream processing of live data streams.</li>
<li><a href="http://storm.apache.org/">Storm</a> - Apache Storm is a distributed stream processing framework.</li>
<li><a href="https://www.freerobotcollective.com/">Strukt</a> - The most interactive way to work with all kinds of tabular data</li>
<li><a href="http://digitalnz.github.io/supplejack/about.html">Supplejack</a> - Supplejack was designed to provide assurance to the quality of data management activities when working at scale.</li>
<li><a href="https://github.com/polettix/teepee">TeePee</a> - Command line tool to extract data from structures</li>
</ul>
</section>
</section>

</div>

</body>
</html>
